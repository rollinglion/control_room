<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Control Room</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
  <script>
    (function blockFileProtocolMode() {
      if (window.location.protocol !== "file:") return;
      const localBase = "http://localhost:8000";
      const localUrl = localBase + "/index.html" + window.location.search + window.location.hash;
      document.open();
      document.write(
        "<!doctype html><html lang='en'><head><meta charset='utf-8'><title>Control Room - Start Local Server</title>" +
        "<meta name='viewport' content='width=device-width, initial-scale=1'>" +
        "<style>" +
        "body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:#0f172a;color:#e2e8f0;display:grid;place-items:center;min-height:100vh;padding:20px;}" +
        ".card{max-width:760px;background:#111827;border:1px solid #334155;border-radius:14px;padding:22px;box-shadow:0 20px 50px rgba(0,0,0,.35);}" +
        "h1{margin:0 0 10px;font-size:22px;}p{line-height:1.45;margin:8px 0 0;}" +
        "code{background:#0b1220;border:1px solid #334155;border-radius:6px;padding:2px 6px;}" +
        ".cmd{margin-top:12px;background:#0b1220;border:1px solid #334155;border-radius:8px;padding:10px 12px;font-family:Consolas,monospace;}" +
        ".row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;}" +
        "a{display:inline-block;text-decoration:none;background:#2563eb;color:#fff;padding:10px 14px;border-radius:8px;font-weight:600;}" +
        ".pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #334155;background:#0b1220;font-size:12px;}" +
        ".muted{opacity:.85;font-size:14px;margin-top:10px;}" +
        "</style></head><body><main class='card'>" +
        "<h1>Run Control Room over HTTP</h1>" +
        "<p>This app cannot load local JSON/GeoJSON when opened as <code>file://</code>. Browser CORS blocks all overlays (rail, roads, airports, service stations).</p>" +
        "<p>Start the included server from this project folder:</p>" +
        "<div class='cmd'>python scripts/dev_server.py</div>" +
        "<div class='row'><a href='" + localUrl + "'>Open http://localhost:8000</a><span id='cr-server-status' class='pill'>Checking localhost...</span></div>" +
        "<p class='muted'>This page auto-redirects when the local server responds.</p>" +
        "<script>(function(){var health='"+ localBase + "/__control_room_health';var target='"+ localUrl + "';var badge=document.getElementById('cr-server-status');function setLabel(t){if(badge)badge.textContent=t;}function ping(){fetch(health,{cache:'no-store'}).then(function(r){if(r.ok){setLabel('Server online. Redirecting...');window.location.replace(target);}else{setLabel('Server not reachable');setTimeout(ping,1200);}}).catch(function(){setLabel('Server not reachable');setTimeout(ping,1200);});}ping();})();<\/script>" +
        "</main></body></html>"
      );
      document.close();
      throw new Error("Control Room must run over http://localhost:8000, not file://");
    })();

  </script>
  <script>(function(){var t=localStorage.getItem('cr-theme')||'indigo';var ok={indigo:1,light:1,noir:1,warm:1,arctic:1,teal:1,rose:1};document.documentElement.dataset.theme=ok[t]?t:'indigo';})();</script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="css/style.css?v=20260218l">
  <!-- vis-network for link analysis graph -->
  <script src="https://unpkg.com/vis-network@9.1.6/standalone/umd/vis-network.min.js"></script>
</head>
<body class="ux-revamp">
  <!-- ═══ KPI DASHBOARD STRIP ═══ -->
  <div id="kpi-bar" class="kpi-bar">
    <div class="kpi-brand">
      <span class="kpi-brand-title">CONTROL ROOM</span>
      <span class="kpi-brand-sub">Intelligence Dashboard</span>
    </div>
    <div class="kpi-separator"></div>
    <div class="kpi-grid">
      <div class="kpi-card" title="Map entities placed">
        <span class="kpi-value" id="kpi-entities">0</span>
        <span class="kpi-label">Entities</span>
      </div>
      <div class="kpi-card" title="Entity connections">
        <span class="kpi-value" id="kpi-connections">0</span>
        <span class="kpi-label">Links</span>
      </div>
      <div class="kpi-card" title="Active overlay layers">
        <span class="kpi-value" id="kpi-layers">0</span>
        <span class="kpi-label">Layers</span>
      </div>
      <div class="kpi-card" title="Searches performed">
        <span class="kpi-value" id="kpi-searches">0</span>
        <span class="kpi-label">Searches</span>
      </div>
      <div class="kpi-card" id="kpi-card-alerts" title="Alert events logged this session">
        <span class="kpi-value" id="kpi-alerts">0</span>
        <span class="kpi-label">Alerts</span>
      </div>
    </div>
    <div class="kpi-separator"></div>
    <div class="kpi-live-info">
      <span class="kpi-clock" id="kpi-clock">--:--:--</span>
      <span class="kpi-coords" id="kpi-coords" title="Map centre coordinates">--</span>
      <span class="kpi-zoom" id="kpi-zoom" title="Zoom level">Z--</span>
    </div>
    <div class="kpi-separator"></div>
    <div class="kpi-pill-group">
      <span class="kpi-pill-label">Map</span>
      <div class="kpi-pills" id="base-pills">
        <button class="kpi-pill active" data-base="Dark">Dark</button>
        <button class="kpi-pill" data-base="Grey">Grey</button>
        <button class="kpi-pill" data-base="Street">Street</button>
        <button class="kpi-pill" data-base="Satellite">Sat</button>
      </div>
    </div>
    <div class="kpi-pill-group">
      <span class="kpi-pill-label">Theme</span>
      <div class="kpi-pills" id="theme-pills">
        <button class="kpi-pill active" data-theme="indigo"><span class="theme-swatch" style="background:#6366f1"></span>Indigo</button>
        <button class="kpi-pill" data-theme="light"><span class="theme-swatch" style="background:#2563eb;box-shadow:0 0 0 1px rgba(0,0,0,0.15)"></span>Light</button>
        <button class="kpi-pill" data-theme="noir"><span class="theme-swatch" style="background:#475569"></span>Noir</button>
        <button class="kpi-pill" data-theme="warm"><span class="theme-swatch" style="background:#f59e0b"></span>Warm</button>
        <button class="kpi-pill" data-theme="arctic"><span class="theme-swatch" style="background:#38bdf8"></span>Arctic</button>
        <button class="kpi-pill" data-theme="teal"><span class="theme-swatch" style="background:#2dd4bf"></span>Teal</button>
        <button class="kpi-pill" data-theme="rose"><span class="theme-swatch" style="background:#f472b6"></span>Rose</button>
      </div>
    </div>
    <div class="kpi-separator"></div>
    <div class="kpi-actions">
      <button class="kpi-action-btn" id="kpi-btn-minimize-ui" title="Focus mode — collapse menus and overlays"><svg class="kpi-btn-icon" width="11" height="11" viewBox="0 0 11 11" fill="none" aria-hidden="true"><path d="M1 2h9M3 0.5v2M8 0.5v2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/><rect x="2" y="4.5" width="7" height="5" rx="0.5" stroke="currentColor" stroke-width="1.2"/></svg>Focus</button>
      <button class="kpi-action-btn" id="kpi-btn-save" title="Save workspace (Ctrl+S)"><svg class="kpi-btn-icon" width="11" height="11" viewBox="0 0 11 11" fill="none" aria-hidden="true"><path d="M1 10V2a1 1 0 011-1h5.5L10 3.5V10a1 1 0 01-1 1H2a1 1 0 01-1-1z" stroke="currentColor" stroke-width="1.2"/><path d="M3.5 1v3h4V1" stroke="currentColor" stroke-width="1.2"/><rect x="2.5" y="6.5" width="6" height="3" rx="0.3" stroke="currentColor" stroke-width="1.2"/></svg>Save</button>
      <button class="kpi-action-btn kpi-action-intel" id="kpi-btn-report" title="Generate 3×5×2 NCA Intelligence Report (Ctrl+Shift+R)"><svg class="kpi-btn-icon" width="11" height="11" viewBox="0 0 11 11" fill="none" aria-hidden="true"><rect x="1" y="0.5" width="9" height="10" rx="1" stroke="currentColor" stroke-width="1.2"/><path d="M3.5 3.5h4M3.5 5.5h4M3.5 7.5h2.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>3×5×2</button>
      <button class="kpi-action-btn" id="kpi-btn-anx" title="Export as i2 Analyst's Notebook ANX (Ctrl+Shift+X)"><svg class="kpi-btn-icon" width="11" height="11" viewBox="0 0 11 11" fill="none" aria-hidden="true"><path d="M6.5 1H10v3.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 1L5.5 5.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/><path d="M4.5 2.5H2A1 1 0 001 3.5V9A1 1 0 002 10H8A1 1 0 009 9V6.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>i2 ANX</button>
      <button class="kpi-action-btn" id="kpi-btn-excel" title="Export structured Excel spreadsheet"><svg class="kpi-btn-icon" width="11" height="11" viewBox="0 0 11 11" fill="none" aria-hidden="true"><rect x="0.5" y="0.5" width="10" height="10" rx="1" stroke="currentColor" stroke-width="1.2"/><path d="M0.5 4h10M0.5 7.5h10M4 0.5v10M7.5 0.5v10" stroke="currentColor" stroke-width="1" opacity="0.6"/></svg>Excel</button>
      <button class="kpi-action-btn" id="kpi-btn-command" title="Open command palette (Ctrl+K)"><svg class="kpi-btn-icon" width="11" height="11" viewBox="0 0 11 11" fill="none" aria-hidden="true"><path d="M1.5 2.5L4 5.5 1.5 8.5" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><path d="M5.5 8.5h4" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg>Cmd</button>
      <button class="kpi-action-btn kpi-action-help" id="kpi-btn-help" title="Keyboard shortcuts reference (F1)"><svg class="kpi-btn-icon" width="11" height="11" viewBox="0 0 11 11" fill="none" aria-hidden="true"><circle cx="5.5" cy="5.5" r="4.5" stroke="currentColor" stroke-width="1.2"/><path d="M4 4.2C4 3.4 4.7 3 5.5 3s1.5.7 1.5 1.5c0 .8-1.5 1.3-1.5 2.2" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/><circle cx="5.5" cy="8.5" r="0.4" fill="currentColor"/></svg>Help</button>
    </div>
  </div>

  <div id="control-panel">
    <div class="cp-header panel-draggable-handle">
      <span class="cp-title" id="cp-title">SEARCH</span>
      <div class="cp-header-actions">
        <button id="cp-toggle" title="Collapse panel" aria-label="Collapse panel">&minus;</button>
      </div>
    </div>
    <!-- Hidden chips kept for map.js DOM references -->
    <span id="cp-active-layers" style="display:none">0</span>
    <span id="cp-entities-chip" style="display:none">0</span>
    <span id="cp-links-chip" style="display:none">0</span>

    <div class="cp-body" id="cp-body">
      <!-- Tabs -->
      <div class="cp-tabs" role="tablist" aria-label="Control panel sections">
        <button id="cp-tab-btn-search" class="cp-tab active" data-tab="search" title="Search companies and people" role="tab" aria-controls="tab-search" aria-selected="true" tabindex="0"><svg class="tab-icon" width="13" height="13" viewBox="0 0 13 13" fill="none" aria-hidden="true"><circle cx="5.5" cy="5.5" r="3.5" stroke="currentColor" stroke-width="1.5"/><path d="M8.5 8.5l2.5 2.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>Search</button>
        <button id="cp-tab-btn-entities" class="cp-tab" data-tab="entities" title="Add custom entities to map" role="tab" aria-controls="tab-entities" aria-selected="false" tabindex="-1"><svg class="tab-icon" width="13" height="13" viewBox="0 0 13 13" fill="none" aria-hidden="true"><circle cx="6.5" cy="4" r="2" stroke="currentColor" stroke-width="1.5"/><path d="M2.5 11.5c0-2.2 1.8-4 4-4s4 1.8 4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>Entities</button>
        <button id="cp-tab-btn-layers" class="cp-tab" data-tab="layers" title="Toggle map layers and base map" role="tab" aria-controls="tab-layers" aria-selected="false" tabindex="-1"><svg class="tab-icon" width="13" height="13" viewBox="0 0 13 13" fill="none" aria-hidden="true"><path d="M1.5 5l5-2.5 5 2.5-5 2.5z" stroke="currentColor" stroke-width="1.3" stroke-linejoin="round"/><path d="M1.5 8.5l5 2.5 5-2.5" stroke="currentColor" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>Layers</button>
      </div>

      <!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â Company Search Tab Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
      <div class="cp-tab-pane active" id="tab-search" role="tabpanel" aria-labelledby="cp-tab-btn-search" aria-hidden="false">
        <div class="ops-source-tabs" role="tablist" aria-label="Search source categories">
          <button type="button" class="ops-source-tab active" data-ops-tab="companies" title="Companies House — search 5.7M UK companies">Companies</button>
          <button type="button" class="ops-source-tab" data-ops-tab="people" title="People, officers and Persons with Significant Control">People</button>
          <button type="button" class="ops-source-tab" data-ops-tab="land" title="HM Land Registry price paid data by postcode">Land Reg.</button>
          <button type="button" class="ops-source-tab" data-ops-tab="disqualified" title="Companies House disqualified directors register">Directors</button>
          <button type="button" class="ops-source-tab" data-ops-tab="charity" title="Charity Commission register for England & Wales">Charities</button>
          <button type="button" class="ops-source-tab" data-ops-tab="mostwanted" title="NCA Most Wanted local database">NCA</button>
          <button type="button" class="ops-source-tab" data-ops-tab="sanvessel" title="Sanctioned vessels by name, IMO, MMSI or flag">Vessels</button>
          <button type="button" class="ops-source-tab" data-ops-tab="vehicle" title="DVLA Vehicle Enquiry Service by registration number">DVLA</button>
        </div>
        <div class="ops-source-pane active" data-ops-pane="companies">
        <div id="data-progress" class="cp-progress done">
          <div class="cp-progress-label">
            <span id="progress-text">Searching...</span>
            <span id="progress-pct">0 %</span>
          </div>
          <div class="cp-progress-track">
            <div class="cp-progress-fill" id="progress-fill"></div>
          </div>
        </div>

        <label for="ch_name">Company Name</label>
        <input id="ch_name" type="text" placeholder="e.g. Bristol City" />

        <label for="ch_number">Company Number</label>
        <input id="ch_number" type="text" placeholder="e.g. 03230871" />

        <details class="panel-disclosure">
          <summary>Advanced Company Filters</summary>
          <label for="ch_postcode">Postcode (filter)</label>
          <input id="ch_postcode" type="text" placeholder="e.g. BS3 2EJ" />

          <label for="ch_town">Post Town (filter)</label>
          <input id="ch_town" type="text" placeholder="e.g. Bristol" />

          <label for="ch_status">Company Status</label>
          <select id="ch_status">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="dissolved">Dissolved</option>
            <option value="liquidation">In Liquidation</option>
            <option value="administration">In Administration</option>
          </select>

          <label for="ch_sic">SIC Code (filter)</label>
          <select id="ch_sic">
            <option value="">All SIC Codes</option>
            <option value="93120">93120 - Activities of sport clubs</option>
            <option value="93110">93110 - Operation of sports facilities</option>
            <option value="64191">64191 - Banks</option>
            <option value="64192">64192 - Building societies</option>
            <option value="64209">64209 - Other financial service activities</option>
            <option value="64303">64303 - Activities of investment trusts</option>
            <option value="68100">68100 - Buying and selling of own real estate</option>
            <option value="68209">68209 - Other letting and operating of own/leased real estate</option>
            <option value="70100">70100 - Activities of head offices</option>
            <option value="64110">64110 - Central banking</option>
            <option value="86101">86101 - Hospital activities</option>
            <option value="86210">86210 - General medical practice activities</option>
            <option value="47110">47110 - Retail sale in non-specialised stores</option>
            <option value="56101">56101 - Licensed restaurants</option>
            <option value="56103">56103 - Take-away food shops and mobile food stands</option>
            <option value="56210">56210 - Event catering activities</option>
            <option value="62012">62012 - Business and domestic software development</option>
            <option value="62020">62020 - Information technology consultancy activities</option>
            <option value="41100">41100 - Development of building projects</option>
            <option value="41201">41201 - Construction of commercial buildings</option>
          </select>
        </details>

        <div class="cp-btn-row">
          <button id="ch_search" class="btn-primary">Search API</button>
          <button id="ch_clear" class="btn-secondary">Clear</button>
        </div>

        <div id="ch-results-skeleton" class="cp-skeleton-list hidden" aria-hidden="true">
          <div class="cp-skeleton-row"></div>
          <div class="cp-skeleton-row"></div>
          <div class="cp-skeleton-row"></div>
        </div>
        <div id="ch_results"></div>

        <!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â QUICK SEARCH (AUTOCOMPLETE) Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
        <div class="api-search-divider">
          <span>-- OR QUICK SEARCH --</span>
        </div>

        <label for="ch_api_search">Type-ahead Search</label>
        <div class="autocomplete-wrapper">
          <input id="ch_api_search" type="text" placeholder="Start typing company name..." />
          <div id="ch_api_suggestions" class="suggestions-dropdown"></div>
        </div>

        <div id="ch_api_selected"></div>
        <!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â END QUICK SEARCH Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
        </div>

        <details class="panel-disclosure ops-source-pane" data-ops-pane="people" id="people-ops-block" open>
          <summary>People / Officer / PSC Search</summary>
          <div id="psc-progress" class="cp-progress done">
            <div class="cp-progress-label">
              <span id="psc-progress-text">Searching...</span>
              <span id="psc-progress-pct"></span>
            </div>
            <div class="cp-progress-track">
              <div class="cp-progress-fill" id="psc-progress-fill"></div>
            </div>
          </div>

          <label for="psc_name">Person / Officer Name</label>
          <input id="psc_name" type="text" placeholder="e.g. John Smith" title="Search for officers by name (min 3 characters)" />

          <label for="psc_company">Company Number (for PSC)</label>
          <input id="psc_company" type="text" placeholder="e.g. 08209948" title="View PSC data for a specific company" />

          <div class="cp-btn-row">
            <button id="psc_search" class="btn-primary" title="Search for PSC or officers via API">Search API</button>
            <button id="psc_clear" class="btn-secondary">Clear</button>
          </div>

          <div class="psc-help-text">
            Enter a person's name to search officer appointments, or a company number to view PSC records with PDF download.
          </div>

          <div id="psc-results-skeleton" class="cp-skeleton-list hidden" aria-hidden="true">
            <div class="cp-skeleton-row"></div>
            <div class="cp-skeleton-row"></div>
            <div class="cp-skeleton-row"></div>
          </div>
          <div id="psc_results"></div>
        </details>

        <details class="panel-disclosure ops-source-pane" data-ops-pane="land" id="land-registry-block" open>
          <summary>Land Registry (Price Paid)</summary>
          <label for="lr-postcode">Postcode</label>
          <div class="roads-row">
            <input id="lr-postcode" type="text" placeholder="e.g. SW1A 1AA" />
            <button id="lr-search-btn" class="btn-primary btn-sm" type="button">Search</button>
          </div>
          <div class="psc-help-text">
            Queries HM Land Registry Price Paid Data. Shows recent property transactions at a postcode.
          </div>
          <div id="lr-results" class="nr-results"></div>
        </details>

        <details class="panel-disclosure ops-source-pane" data-ops-pane="disqualified" id="disqualified-directors-block" open>
          <summary>Disqualified Directors</summary>
          <label for="dq-name">Director Name</label>
          <div class="roads-row">
            <input id="dq-name" type="text" placeholder="e.g. John Smith" />
            <button id="dq-search-btn" class="btn-primary btn-sm" type="button">Search</button>
          </div>
          <div class="psc-help-text">
            Searches Companies House disqualified officers register.
          </div>
          <div id="dq-results" class="nr-results"></div>
        </details>

        <details class="panel-disclosure ops-source-pane" data-ops-pane="charity" id="charity-block" open>
          <summary>Charity Commission</summary>
          <label for="charity-name">Charity Name</label>
          <div class="roads-row">
            <input id="charity-name" type="text" placeholder="e.g. British Red Cross" />
            <button id="charity-search-btn" class="btn-primary btn-sm" type="button">Search</button>
          </div>
          <div class="psc-help-text">
            Searches the Charity Commission register for England & Wales.
          </div>
          <div id="charity-results" class="nr-results"></div>
        </details>

        <details class="panel-disclosure ops-source-pane" data-ops-pane="mostwanted" id="mostwanted-block" open>
          <summary>UK NCA Most Wanted (Local)</summary>
          <label for="mostwanted-name">Name / Alias / Notes</label>
          <div class="roads-row">
            <input id="mostwanted-name" type="text" placeholder="e.g. surname, alias, offence keyword" />
            <button id="mostwanted-search-btn" class="btn-primary btn-sm" type="button">Search</button>
            <button id="mostwanted-clear-btn" class="btn-secondary btn-sm" type="button">Clear</button>
          </div>
          <div id="mostwanted-meta" class="mostwanted-status" aria-live="polite"></div>
          <div id="mostwanted-results" class="nr-results"></div>
        </details>

        <details class="panel-disclosure ops-source-pane" data-ops-pane="sanvessel" id="sanvessel-block" open>
          <summary>Sanctioned Vessels (Local)</summary>
          <label for="sanvessel-name">Vessel / IMO / MMSI / Flag / Risk</label>
          <div class="roads-row">
            <input id="sanvessel-name" type="text" placeholder="e.g. vessel name, IMO number, risk tag" />
            <button id="sanvessel-search-btn" class="btn-primary btn-sm" type="button">Search</button>
            <button id="sanvessel-clear-btn" class="btn-secondary btn-sm" type="button">Clear</button>
          </div>
          <div class="cp-btn-row">
            <button id="sanvessel-highlight-btn" class="btn-secondary btn-sm" type="button">Highlight Sanctioned On AIS</button>
          </div>
          <div id="sanvessel-meta" class="mostwanted-status" aria-live="polite"></div>
          <div id="sanvessel-results" class="nr-results"></div>
        </details>

        <details class="panel-disclosure ops-source-pane" data-ops-pane="vehicle" id="dvla-ops-block" open>
          <summary>DVLA Vehicle Lookup</summary>
          <label for="dvla-vrm-input">Registration Number (VRM)</label>
          <div class="roads-row">
            <input id="dvla-vrm-input" type="text" placeholder="e.g. AB12CDE" />
            <button id="dvla-lookup-btn" class="btn-primary btn-sm" type="button">Lookup</button>
          </div>
          <div class="cp-btn-row">
            <button id="dvla-clear-btn" class="btn-secondary btn-sm" type="button">Clear</button>
          </div>
          <div class="psc-help-text">
            Queries DVLA Vehicle Enquiry Service via proxy. Results can be added to map as i2 Vehicle entities.
          </div>
          <div id="dvla-results" class="nr-results"></div>
        </details>

      </div>

      <!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â Entities Tab Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
      <div class="cp-tab-pane" id="tab-entities" role="tabpanel" aria-labelledby="cp-tab-btn-entities" aria-hidden="true">
        <!-- Entity Search -->
        <div class="entity-search-panel">
          <div class="entity-search-row">
            <input id="entity-search-input" type="text" placeholder="Search entities..." class="entity-search-input" autocomplete="off" />
            <select id="entity-search-type-filter" class="entity-search-filter">
              <option value="">All Types</option>
              <option value="person">Person</option>
              <option value="vehicle">Vehicle</option>
              <option value="organisation">Organisation</option>
              <option value="location">Location</option>
              <option value="phone">Phone</option>
              <option value="email">Email</option>
              <option value="vessel">Vessel</option>
              <option value="aircraft">Aircraft</option>
              <option value="document">Document</option>
            </select>
          </div>
          <div id="entity-search-results" class="entity-search-results-container"></div>
        </div>

        <details class="panel-disclosure">
          <summary>Quick Guide</summary>
          <div class="entity-help">
            <strong>Entity Placement + i2 Workspace</strong>
            <p><strong>To place:</strong> Click a category below -> click on map -> enter details (name, address, notes)</p>
            <p><strong>To connect:</strong> Click Connect on any entity -> click target entity -> enter label</p>
            <p>Icons auto-suggest based on i2 fields and entity content.</p>
          </div>
        </details>

        <details class="panel-disclosure">
          <summary>Import & Bulk Tools</summary>
          <div class="entity-import-panel">
            <div class="entity-import-title">Import Files</div>
            <input id="entity-import-file" type="file" accept=".xlsx,.xls,.csv,.tsv,.txt,.pdf,.docx,.doc,.rtf,.html,.htm,.xml,.odt,.json,.geojson" />
            <div class="cp-btn-row">
              <button id="entity-import-run" class="btn-primary">Import And Plot</button>
              <button id="entity-import-template" class="btn-secondary" type="button">Download Template</button>
              <button id="entity-import-clear" class="btn-secondary">Clear Imported</button>
            </div>
            <div class="cp-btn-row">
              <button id="entity-select-box" class="btn-secondary" type="button">Box Select</button>
              <button id="entity-select-all" class="btn-secondary" type="button">Select All (Ctrl+A)</button>
              <button id="entity-export-excel" class="btn-secondary" type="button">Export Excel</button>
            </div>
            <div id="entity-import-summary" class="entity-import-summary">
              Supports xlsx/xls/csv/tsv/txt for entities, pdf/docx/doc/rtf/html/xml/odt/txt for intel reports, json/geojson for overlays. Drag and drop supported.
            </div>
          </div>
        </details>

        <details class="panel-disclosure">
          <summary>Document Converter</summary>
          <div class="doc-converter-panel">
            <div class="doc-converter-title">Document Converter</div>
            <div class="doc-converter-hint">Convert messy filenames to standardised format: <code>YYYYMMDD - Source - Subject</code></div>
            <div class="cp-btn-row">
              <button id="doc-converter-btn" class="btn-secondary" type="button">Browse Files</button>
              <button id="doc-converter-dl-all" class="btn-secondary" type="button">Download All</button>
            </div>
            <input id="doc-converter-input" type="file" multiple accept=".pdf,.txt,.xlsx,.xls,.csv,.doc,.docx,.rtf,.html,.htm,.xml,.odt" style="display:none" />
            <div id="doc-converter-results" class="dc-results">
              <div class="dc-empty">Drop files or click Browse to convert</div>
            </div>
          </div>
        </details>

        <details class="panel-disclosure">
          <summary>Entity Palette</summary>
          <div id="entity_selector" class="entity-grid">
            <!-- Populated by JavaScript -->
          </div>
          <div class="entity-stats">
            <div class="entity-stat-item">
              <span class="entity-stat-label">Entities on map:</span>
              <span id="entity_count" class="entity-stat-value">0</span>
            </div>
            <div class="entity-stat-item">
              <span class="entity-stat-label">Connections:</span>
              <span id="connection_count" class="entity-stat-value">0</span>
            </div>
          </div>
        </details>

        <details class="panel-disclosure">
          <summary>Search History &amp; Bookmarks</summary>
          <div id="search-history-list" class="search-history-list">
            <div class="activity-empty">No search history yet.</div>
          </div>
        </details>

        <details class="panel-disclosure">
          <summary>Workspace Manager</summary>
          <div class="ws-controls">
            <div class="roads-row">
              <input id="ws-name-input" type="text" placeholder="Workspace name" value="default" />
              <button id="ws-save-btn" class="btn-primary btn-sm" type="button">Save</button>
            </div>
            <div class="cp-btn-row">
              <button id="ws-quicksave-btn" class="btn-secondary btn-sm" type="button">Quick Save</button>
              <button id="ws-quickload-btn" class="btn-secondary btn-sm" type="button">Quick Load</button>
            </div>
            <div class="psc-help-text">
              Save/restore your entire workspace: entities, connections, map position, layers. Auto-saves every 2 minutes.
            </div>
          </div>
          <div id="workspace-list" class="workspace-list">
            <div class="activity-empty">No saved workspaces.</div>
          </div>
        </details>

        <details class="panel-disclosure">
          <summary>Google Intelligence</summary>
          <div class="google-api-dashboard">
            <div class="google-api-header">
              <span>Google Maps Platform Intelligence</span>
              <div class="cp-btn-row">
                <button id="google-api-refresh-btn" class="btn-secondary btn-sm" type="button">Refresh</button>
                <button id="google-api-selftest-btn" class="btn-secondary btn-sm" type="button">Probe</button>
                <button id="google-api-enrich-selected-btn" class="btn-secondary btn-sm" type="button">Enrich Selected</button>
              </div>
            </div>
            <div id="google-api-state" class="google-api-state">Checking key + service availability...</div>
            <div id="google-api-capability-matrix" class="google-api-capability-matrix"></div>
            <div id="google-api-dashboard-list" class="google-api-dashboard-list"></div>
            <div id="google-api-selftest" class="psc-help-text">Awaiting probe...</div>

            <div class="google-tools-grid">
              <section class="google-tool-card">
                <h4>Location Intel</h4>
                <div class="google-tool-row">
                  <input id="google-intel-location" type="text" placeholder="Address or lat,lng" />
                  <button id="google-intel-run-btn" class="btn-primary btn-sm" type="button">Analyze</button>
                </div>
                <div class="google-tool-row">
                  <button id="google-intel-use-map-btn" class="btn-secondary btn-sm" type="button">Use Map Center</button>
                  <button id="google-intel-clear-btn" class="btn-secondary btn-sm" type="button">Clear</button>
                </div>
                <div id="google-intel-output" class="google-tool-output">No analysis yet.</div>
              </section>

              <section class="google-tool-card">
                <h4>Places Search</h4>
                <div class="google-tool-row">
                  <input id="google-places-query" type="text" placeholder="e.g. cash point, vehicle repair, storage" />
                  <button id="google-places-run-btn" class="btn-primary btn-sm" type="button">Search</button>
                </div>
                <div class="google-tool-row">
                  <label class="google-tool-check">
                    <input id="google-places-near-map" type="checkbox" checked />
                    Bias to map center
                  </label>
                </div>
                <div id="google-places-output" class="google-tool-output">No places results yet.</div>
              </section>

              <section class="google-tool-card">
                <h4>Route Estimate</h4>
                <div class="google-tool-row">
                  <input id="google-route-origin" type="text" placeholder="Origin (address or lat,lng)" />
                </div>
                <div class="google-tool-row">
                  <input id="google-route-destination" type="text" placeholder="Destination (address or lat,lng)" />
                </div>
                <div class="google-tool-row">
                  <select id="google-route-mode">
                    <option value="driving">Driving</option>
                    <option value="walking">Walking</option>
                    <option value="bicycling">Cycling</option>
                    <option value="transit">Transit</option>
                  </select>
                  <button id="google-route-run-btn" class="btn-primary btn-sm" type="button">Compute</button>
                </div>
                <div id="google-route-output" class="google-tool-output">No route analysis yet.</div>
              </section>
            </div>
          </div>
        </details>

        <details class="panel-disclosure" id="entities-i2-workspace">
          <summary>i2 Planning Workspace</summary>
          <div class="i2-stats-grid">
            <div class="i2-stat-card">
              <span class="i2-stat-label">Import Templates</span>
              <span id="i2-template-count" class="i2-stat-value">--</span>
            </div>
            <div class="i2-stat-card">
              <span class="i2-stat-label">Entity Types</span>
              <span id="i2-entity-count" class="i2-stat-value">--</span>
            </div>
            <div class="i2-stat-card">
              <span class="i2-stat-label">Link Types</span>
              <span id="i2-link-count" class="i2-stat-value">--</span>
            </div>
            <div class="i2-stat-card">
              <span class="i2-stat-label">Match Rules</span>
              <span id="i2-rule-count" class="i2-stat-value">--</span>
            </div>
          </div>

          <label for="i2-template-select">Import Template</label>
          <select id="i2-template-select">
            <option value="">Loading templates...</option>
          </select>
          <div id="i2-template-details" class="i2-panel-block">Select a template to inspect mappings.</div>

          <label for="i2-entity-search">Entity Type Search</label>
          <input id="i2-entity-search" type="text" placeholder="e.g. Communication Entity, Aircraft, Person" />
          <div id="i2-entity-results" class="i2-panel-block">Loading catalog...</div>
        </details>
      </div>

      <!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â Layers Tab Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
      <div class="cp-tab-pane" id="tab-layers" role="tabpanel" aria-labelledby="cp-tab-btn-layers" aria-hidden="true">
        <div class="layer-search-panel">
          <div class="layer-search-input">
            <input id="layer-search-input" type="text" placeholder="Search layers (e.g. rail, crime, telecom)" aria-label="Search layers" />
            <button id="layer-search-clear" class="btn-secondary btn-sm" type="button">Clear</button>
          </div>
          <div class="layer-search-meta">Filter stacks instantly or press <kbd>Esc</kbd> to reset.</div>
        </div>

        <div class="layer-section-title">Layer Controls</div>
        <div id="layer-search-empty" class="layer-search-empty hidden">No layers match your search filter.</div>

        <details class="panel-disclosure layer-group" data-layer-group="intel">
          <summary><span class="layer-icon summary-icon" data-icon="building"></span>Core &amp; Intel</summary>

          <label class="layer-row" data-layer-name="Companies (search)">
            <input type="checkbox" class="layer-cb" data-layer="companies" checked>
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-icon" data-icon="building" style="--lc:#a78bfa"></span>
            <span class="layer-name">Companies (search)</span>
          </label>
        </details>

        <details class="panel-disclosure layer-group" data-layer-group="transport">
          <summary><span class="layer-icon summary-icon" data-icon="bus"></span>Transport</summary>

          <label class="layer-row" data-layer-name="TfL Stations (Underground, DLR, Tram, Rail)">
            <input type="checkbox" class="layer-cb" data-layer="underground">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-icon" data-icon="rail-metro" style="--lc:#f43f5e"></span>
            <span class="layer-name">TfL Stations (Underground, DLR, Tram, Rail)</span>
          </label>

          <label class="layer-row" data-layer-name="National Rail Stations">
            <input type="checkbox" class="layer-cb" data-layer="national_rail">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-icon" data-icon="rail" style="--lc:#38bdf8"></span>
            <span class="layer-name">National Rail Stations</span>
          </label>
          <div class="layer-sub-pills" data-requires="national_rail">
            <button class="layer-sub-pill active" data-rail-mode="all">All Railways</button>
            <button class="layer-sub-pill" data-rail-mode="major">Major</button>
            <button class="layer-sub-pill" data-rail-mode="minor">Minor</button>
          </div>

          <label class="layer-row" data-layer-name="Service Stations (Fuel/EV)">
            <input type="checkbox" class="layer-cb" data-layer="service_stations">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-icon" data-icon="fuel" style="--lc:#facc15"></span>
            <span class="layer-name">Service Stations (Fuel/EV)</span>
          </label>

          <label class="layer-row" data-layer-name="Santander Cycles">
            <input type="checkbox" class="layer-cb" data-layer="bikes">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-icon" data-icon="bicycle-share" style="--lc:#22c55e"></span>
            <span class="layer-name">Santander Cycles</span>
          </label>
        </details>

        <details class="panel-disclosure layer-group" data-layer-group="aviation">
          <summary><span class="layer-icon summary-icon" data-icon="airport"></span>Aviation</summary>

          <label class="layer-row" data-layer-name="UK Airports">
            <input type="checkbox" class="layer-cb" data-layer="airports_uk">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-icon" data-icon="airport" style="--lc:#38bdf8"></span>
            <span class="layer-name">UK Airports</span>
          </label>

          <label class="layer-row" data-layer-name="Global Airports">
            <input type="checkbox" class="layer-cb" data-layer="airports_global">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-icon" data-icon="airport" style="--lc:#0284c7"></span>
            <span class="layer-name">Global Airports</span>
          </label>

          <label class="layer-row" data-layer-name="Live Flights (FlightRadar24)">
            <input type="checkbox" class="layer-cb" data-layer="flights">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-icon" data-icon="airport" style="--lc:#f59e0b"></span>
            <span class="layer-name">Live Flights (FlightRadar24)</span>
          </label>
        </details>

        <details class="panel-disclosure layer-tool-block">
          <summary>Aviation Finder</summary>
          <div class="airport-tools">
            <label for="airport-search-q">Airport (IATA / ICAO / Name / City)</label>
            <div class="airport-row">
              <input id="airport-search-q" type="text" placeholder="e.g. BRS, EGGD, Bristol" />
              <button id="airport-search-btn" class="btn-secondary btn-sm" type="button">Find</button>
            </div>
            <div class="airport-row">
              <button id="airport-search-clear-btn" class="btn-secondary btn-sm" type="button">Clear</button>
            </div>
            <div id="airport-search-results" class="airport-results"></div>
          </div>
        </details>
        <details class="panel-disclosure layer-group" data-layer-group="maritime">
          <summary><span class="layer-icon summary-icon" data-icon="ferry"></span>Maritime</summary>

          <label class="layer-row" data-layer-name="Seaports">
            <input type="checkbox" class="layer-cb" data-layer="seaports">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-icon" data-icon="harbor" style="--lc:#2dd4bf"></span>
            <span class="layer-name">Seaports</span>
          </label>

          <label class="layer-row" data-layer-name="Ships (AIS Live)">
            <input type="checkbox" class="layer-cb" data-layer="ships">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-icon" data-icon="ferry" style="--lc:#06b6d4"></span>
            <span class="layer-name">Ships (AIS Live)</span>
          </label>

        </details>

        <details class="panel-disclosure layer-group" data-layer-group="infrastructure">
          <summary><span class="layer-icon summary-icon" data-icon="police"></span>Infrastructure &amp; Crime</summary>

          <label class="layer-row" data-layer-name="Cell Towers (Telecom Infrastructure)">
            <input type="checkbox" class="layer-cb" data-layer="cellTowers">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-icon" data-icon="communications-tower" style="--lc:#22c55e"></span>
            <span class="layer-name">Cell Towers (Telecom Infrastructure)</span>
          </label>

          <label class="layer-row" data-layer-name="Police Force Areas">
            <input type="checkbox" class="layer-cb" data-layer="areas">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-icon" data-icon="police" style="--lc:#818cf8"></span>
            <span class="layer-name">Police Force Areas</span>
          </label>

          <label class="layer-row" data-layer-name="Crime Incidents">
            <input type="checkbox" class="layer-cb" data-layer="crime">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-icon" data-icon="danger" style="--lc:#ef4444"></span>
            <span class="layer-name">Crime Incidents</span>
          </label>

        </details>
        <details class="panel-disclosure layer-tool-block" data-layer-tools="crime">
          <summary>Crime Intelligence Console</summary>

          <div class="crime-intel-tools">
            <div class="crime-summary-row">
              <div class="crime-summary-card">
                <span class="crime-summary-label">Incidents</span>
                <span class="crime-summary-value" id="crime-summary-incidents">--</span>
              </div>
              <div class="crime-summary-card">
                <span class="crime-summary-label">Stop &amp; Search</span>
                <span class="crime-summary-value" id="crime-summary-stops">--</span>
              </div>
              <div class="crime-summary-card">
                <span class="crime-summary-label">Outcomes</span>
                <span class="crime-summary-value" id="crime-summary-outcomes">--</span>
              </div>
              <div class="crime-summary-card">
                <span class="crime-summary-label">Active Cells</span>
                <span class="crime-summary-value" id="crime-summary-cells">--</span>
              </div>
            </div>

            <div class="crime-filter-actions-row">
              <button id="crime-show-all-btn" class="btn-secondary btn-sm" type="button">UK Overview</button>
              <button id="crime-filter-force-btn" class="btn-secondary btn-sm" type="button">Use Selected Police Force</button>
              <button id="crime-reset-filter-btn" class="btn-secondary btn-sm" type="button">Reset Filters</button>
              <button id="crime-clear-filter-btn" class="btn-secondary btn-sm" type="button">Clear Selection</button>
            </div>
            <div class="crime-filter-actions-row">
              <input id="crime-force-search" type="text" placeholder="Quick force search (e.g. met, west midlands)" class="crime-force-search-input" />
              <button id="crime-force-search-apply" class="btn-secondary btn-sm" type="button">Select Top Match</button>
              <button id="crime-box-mode-btn" class="btn-secondary btn-sm" type="button">Draw Area Box</button>
              <button id="crime-box-clear-btn" class="btn-secondary btn-sm" type="button">Clear Area Box</button>
            </div>

            <div class="crime-filter-columns">
              <div class="crime-filter-card">
                <label>Police Forces</label>
                <div class="crime-filter-field">
                  <select id="crime-force-filter" multiple size="6" class="airport-results"></select>
                </div>
              </div>
              <div class="crime-filter-card">
                <label>Crime Types</label>
                <div class="crime-filter-field">
                  <select id="crime-type-filter" multiple size="6" class="airport-results"></select>
                </div>
              </div>
              <div class="crime-filter-card crime-timeline-card">
                <label>Timeline</label>
                <div class="crime-timeline-slider">
                  <input type="range" id="crime-month-slider" min="0" max="0" value="0" />
                  <div id="crime-month-slider-label" class="crime-timeline-label">Timeline loading…</div>
                </div>
                <div class="crime-window-pills">
                  <button class="crime-window-pill" data-month-window="3" type="button">Last 3 months</button>
                  <button class="crime-window-pill" data-month-window="6" type="button">Last 6 months</button>
                  <button class="crime-window-pill" data-month-window="12" type="button">Last 12 months</button>
                  <button class="crime-window-pill" data-month-window="0" type="button">All months</button>
                </div>
              </div>
            </div>

            <div id="crime-filter-status" class="crime-filter-status">Crime data pending</div>

            <div class="crime-inspector" id="crime-inspector">
              <div class="crime-inspector-empty" id="crime-inspector-empty">
                Activate any crime grid cell to review timelines, outcomes, and exact incident samples.
              </div>
              <div class="crime-inspector-body hidden" id="crime-inspector-body">
                <div class="crime-inspector-header">
                  <div>
                    <div class="crime-inspector-title" id="crime-inspector-title">Crime cell</div>
                    <div class="crime-inspector-subtitle" id="crime-inspector-subtitle"></div>
                  </div>
                  <div class="crime-inspector-actions">
                    <button id="crime-inspector-zoom" class="btn-secondary btn-sm" type="button">Zoom</button>
                    <button id="crime-inspector-clear" class="btn-secondary btn-sm" type="button">Clear</button>
                  </div>
                </div>
                <div class="crime-inspector-range" id="crime-inspector-range">All months</div>
                <div class="crime-inspector-stats">
                  <div class="crime-inspector-stat">
                    <span class="crime-inspector-value" id="crime-inspector-incidents">--</span>
                    <span class="crime-inspector-label">Incidents</span>
                  </div>
                  <div class="crime-inspector-stat">
                    <span class="crime-inspector-value" id="crime-inspector-stops">--</span>
                    <span class="crime-inspector-label">Stop &amp; Search</span>
                  </div>
                  <div class="crime-inspector-stat">
                    <span class="crime-inspector-value" id="crime-inspector-outcomes">--</span>
                    <span class="crime-inspector-label">Outcomes</span>
                  </div>
                </div>
                <div class="crime-inspector-timeline" id="crime-inspector-timeline"></div>
                <div class="crime-incident-list-header">
                  <span>Recent incidents (up to 6 samples)</span>
                  <div class="crime-incident-actions">
                    <button id="crime-incident-clear-pins" class="btn-secondary btn-sm" type="button">Clear Pins</button>
                  </div>
                </div>
                <div class="crime-incident-list" id="crime-incident-list">
                  <div class="crime-incident-empty" id="crime-incident-empty">Exact incident samples will appear here.</div>
                </div>
              </div>
            </div>
          </div>
        </details>


        <details class="panel-disclosure layer-tool-block" data-layer-tools="service_stations">
          <summary>Service Station Filters</summary>
          <div class="service-filter-tools">
            <label class="inline-checkbox">
              <input id="ss-filter-fuel" type="checkbox" checked />
              Fuel
            </label>
            <label class="inline-checkbox">
              <input id="ss-filter-charging" type="checkbox" checked />
              EV Charging
            </label>
            <label class="inline-checkbox">
              <input id="ss-filter-vehicle" type="checkbox" checked />
              Repair / Wash
            </label>
            <label class="inline-checkbox">
              <input id="ss-filter-truck" type="checkbox" checked />
              Truck Stops
            </label>
            <label class="inline-checkbox">
              <input id="ss-filter-general" type="checkbox" checked />
              Other
            </label>
            <div class="cp-btn-row">
              <button id="ss-filter-all-btn" class="btn-secondary btn-sm" type="button">All</button>
              <button id="ss-filter-none-btn" class="btn-secondary btn-sm" type="button">None</button>
            </div>
          </div>
        </details>

        <details class="panel-disclosure layer-tool-block" data-layer-tools="underground">
          <summary>
            TfL Line Status
            <span id="tfl-status-time" class="tfl-status-time">--:--</span>
          </summary>
          <div id="tfl-selected-line" class="tfl-selected-line">Selected: None</div>
          <div id="tfl-status-grid"></div>
        </details>

        <details class="panel-disclosure layer-tool-block" data-layer-tools="underground">
          <summary>TfL StopPoint Ops</summary>
          <div class="tfl-stop-tools">
            <label for="tfl-stop-query">Search Stops / Stations</label>
            <div class="tfl-stop-row">
              <input id="tfl-stop-query" type="text" placeholder="e.g. Baker Street or 490008660N" />
              <button id="tfl-stop-search-btn" class="btn-secondary btn-sm" type="button">Search</button>
            </div>

            <label for="tfl-stop-mode">Mode Filter</label>
            <select id="tfl-stop-mode">
              <option value="">All modes</option>
              <option value="tube">Tube</option>
              <option value="overground">Overground</option>
              <option value="elizabeth-line">Elizabeth line</option>
              <option value="dlr">DLR</option>
              <option value="tram">Tram</option>
              <option value="bus">Bus</option>
            </select>

            <div class="tfl-stop-row">
              <button id="tfl-stop-nearby-btn" class="btn-secondary btn-sm" type="button">Nearby (Map Center)</button>
              <button id="tfl-stop-clear-btn" class="btn-secondary btn-sm" type="button">Clear</button>
            </div>
          <div id="tfl-stop-results" class="tfl-stop-results"></div>
          </div>
        </details>

        <details class="panel-disclosure layer-tool-block" data-layer-tools="national_rail">
          <summary>National Rail Ops</summary>
          <div class="nr-tools">
            <label for="nr-station-query">Station / CRS</label>
            <div class="nr-row">
              <input id="nr-station-query" type="text" placeholder="e.g. Kings Cross or KGX" />
              <button id="nr-station-search-btn" class="btn-secondary btn-sm" type="button">Search</button>
            </div>
            <div class="nr-row">
              <button id="nr-station-nearby-btn" class="btn-secondary btn-sm" type="button">Nearby (Map Center)</button>
              <button id="nr-station-clear-btn" class="btn-secondary btn-sm" type="button">Clear</button>
            </div>
            <div id="nr-selected-line" class="nr-selected-line">Selected Major Line: None</div>
            <div class="cp-btn-row">
              <button id="nr-mode-major-btn" class="btn-secondary btn-sm" type="button">Major Only</button>
              <button id="nr-mode-minor-btn" class="btn-secondary btn-sm" type="button">Minor Only</button>
              <button id="nr-mode-all-net-btn" class="btn-secondary btn-sm" type="button">All</button>
            </div>
            <div class="cp-btn-row">
              <button id="nr-line-all-btn" class="btn-secondary btn-sm" type="button">All Lines</button>
              <button id="nr-line-none-btn" class="btn-secondary btn-sm" type="button">No Lines</button>
            </div>
            <div id="nr-major-line-grid" class="nr-major-line-grid"></div>
            <div id="nr-station-results" class="nr-results"></div>
          </div>
        </details>

      </div>

    </div>
  </div>

  <!-- Status bar -->
  <!-- Entity Inspector Panel (right slide-out) -->
  <div id="entity-inspector">
    <button class="inspector-close" id="inspector-close-btn" title="Close inspector">&times;</button>
    <div id="inspector-type-badge" class="inspector-type-badge">Entity</div>
    <div id="inspector-label" class="inspector-label">—</div>
    <div id="inspector-streetview" class="inspector-section"></div>
    <div class="inspector-section">
      <h4>Attributes</h4>
      <table id="inspector-attrs" class="inspector-attr-table"><tbody></tbody></table>
    </div>
    <div class="inspector-section">
      <h4>Source</h4>
      <div id="inspector-source">—</div>
    </div>
    <div class="inspector-section">
      <h4>Relationships</h4>
      <ul id="inspector-relationships" class="inspector-relationships"><li>None</li></ul>
    </div>
    <div class="inspector-section">
      <div class="popup-btn-row">
        <button class="popup-psc-btn" id="inspector-edit-btn">Edit</button>
        <button class="popup-psc-btn" id="inspector-connect-btn">Connect</button>
        <button class="popup-psc-btn" id="inspector-remove-btn">Remove</button>
      </div>
    </div>
  </div>

  <div id="status-bar">
    <div class="status-left">
      <span class="status-indicator" id="status-indicator"></span>
      <span id="status-text" role="status" aria-live="polite">Initialising...</span>
    </div>
    <div class="status-center">
      <span class="status-session-chip" id="status-session">Session: 0m</span>
    </div>
    <div id="status-health-mini" class="status-health-mini">
      <span class="status-health-chip">Health: checking...</span>
    </div>
  </div>

  <!-- Entity Placement Panel -->
  <div id="entity-placement-panel" class="entity-panel">
    <div class="entity-panel-header">
      <span class="entity-panel-title">PLACE ENTITY</span>
      <div class="entity-panel-header-actions">
        <button id="entity-panel-minimize" class="entity-panel-min-btn" type="button" title="Minimize panel">-</button>
        <button id="entity-panel-close" class="entity-panel-close-btn" type="button" title="Close panel">&times;</button>
      </div>
    </div>
    <div class="entity-panel-body">
      <form id="entity-placement-form">
        <label for="entity-label">Display Label <span style="opacity: 0.5; font-weight: 400;">(optional override)</span></label>
        <input type="text" id="entity-label" placeholder="Leave blank to derive from i2 fields" />
        
        <label for="entity-category">Category</label>
        <select id="entity-category" required>
          <option value="">Select category...</option>
        </select>
        
        <label for="entity-icon">Icon</label>
        <select id="entity-icon" required>
          <option value="">Select icon...</option>
        </select>
        <div id="entity-icon-picker" class="entity-icon-picker"></div>
        <div id="entity-icon-preview" class="entity-icon-preview">
          <img id="entity-icon-preview-img" src="" alt="Selected icon preview" />
          <span id="entity-icon-preview-label">No icon selected</span>
        </div>

        <label for="entity-i2-type">i2 Entity Type</label>
        <select id="entity-i2-type">
          <option value="">Loading i2 entity types...</option>
        </select>

        <div class="cp-btn-row entity-panel-actions-top">
          <button type="submit" class="btn-primary">PLACE ENTITY</button>
          <button type="button" class="btn-secondary" id="entity-cancel-btn">CANCEL</button>
        </div>

        <div id="entity-i2-fields" class="entity-i2-fields">
          <div class="entity-i2-fields-empty">Loading i2 properties...</div>
        </div>

        <label for="entity-placement-address">Placement Address / Postcode <span style="opacity: 0.5; font-weight: 400;">(optional)</span></label>
        <input type="text" id="entity-placement-number" placeholder="House number (e.g. 1)" />
        <input type="text" id="entity-placement-address" placeholder="e.g. 1 Osmond Drive, Wells, BA5 2JX" />
        <div class="entity-i2-meta">Used for map geocoding when postcode/address is not present in i2 fields.</div>
        
        <div class="entity-panel-coords">
          <span class="popup-label">Coordinates</span>
          <span id="entity-coords">--</span>
        </div>
        
      </form>
    </div>
  </div>

  <div id="map"></div>
  <div id="map-theme-overlay" aria-hidden="true"></div>
  <aside id="mostwanted-side-panel" class="mostwanted-side-panel hidden" aria-label="Most Wanted Results">
    <div class="mostwanted-side-header">
      <span>Most Wanted Results</span>
      <button id="mostwanted-side-close" type="button" title="Hide results">&times;</button>
    </div>
    <div id="mostwanted-side-meta" class="mostwanted-status inline"></div>
    <div id="mostwanted-side-results" class="mostwanted-side-results"></div>
  </aside>

  <!-- ═══ BOTTOM ANALYSIS PANEL ═══ -->
  <div id="bottom-panel" class="bottom-panel">
    <div class="bp-header">
      <div class="bp-tabs">
        <button class="bp-tab-btn" data-bp-target="mapstate" title="Layer and cache status">Map State</button>
        <button class="bp-tab-btn" data-bp-target="graph" title="Network Graph (Ctrl+G)">Link Analysis</button>
        <button class="bp-tab-btn" data-bp-target="timeline" title="Timeline (Ctrl+T)">Timeline</button>
        <button class="bp-tab-btn" data-bp-target="activity" title="Activity Log (Ctrl+H)">Activity</button>
      </div>
      <div class="bp-header-right">
        <div id="graph-stats" class="bp-stats"></div>
        <div id="timeline-stats" class="bp-stats" style="display:none"></div>
        <button class="bp-close-btn" id="bp-close-btn" title="Close panel">&times;</button>
      </div>
    </div>
    <div class="bp-body">
      <div class="bp-tab-pane" data-bp-tab="mapstate">
        <div class="bp-layer-state">
          <div class="layer-status-grid">
            <div class="layer-status-card">
              <span class="layer-status-label">Active Layers</span>
              <span class="layer-status-value" id="layer-summary-active">0</span>
              <span class="layer-status-sub">Currently visible on map</span>
            </div>
            <div class="layer-status-card">
              <span class="layer-status-label">Warmed Datasets</span>
              <span class="layer-status-value" id="layer-summary-warmed">0</span>
              <span class="layer-status-sub">Idle prefetched overlays</span>
            </div>
            <div class="layer-status-card layer-status-card-compact">
              <span class="layer-status-label">Prefetch</span>
              <span class="layer-status-chip" id="layer-summary-prefetch">AUTO</span>
              <span class="layer-status-sub" id="layer-summary-prefetch-detail">Evaluating connection...</span>
            </div>
          </div>
        </div>
      </div>
      <!-- Graph Tab -->
      <div class="bp-tab-pane" data-bp-tab="graph">
        <div id="graph-toolbar" class="graph-toolbar"></div>
        <div id="network-graph-container" class="network-graph-container"></div>
      </div>
      <!-- Timeline Tab -->
      <div class="bp-tab-pane" data-bp-tab="timeline">
        <div id="timeline-toolbar" class="graph-toolbar"></div>
        <div id="timeline-container" class="timeline-container"></div>
      </div>
      <!-- Activity Tab -->
      <div class="bp-tab-pane" data-bp-tab="activity">
        <div id="activity-log-list" class="activity-log-list"></div>
      </div>
    </div>
  </div>

  <button id="mobile-panel-toggle" class="mobile-panel-toggle" type="button" title="Toggle control panel">Panel</button>
  <div id="toast-stack" class="toast-stack" aria-live="polite" aria-atomic="false"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>if(window.pdfjsLib)pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";</script>
  <script src="https://cdn.jsdelivr.net/npm/mammoth@1.6.0/mammoth.browser.min.js"></script>

  <!-- API Keys s (gitignored Ã¢â‚¬â€ copy api_keys.example.js to api_keys.js) -->
  <script src="js/api_keys.js"></script>

  <!-- Core Config -->
  <script src="js/config.js"></script>
  <script src="js/api_base.js"></script>
  <script type="module" src="Control%20Room_core/services/google_intelligence_service.js?v=20260218g"></script>
  <script type="module" src="Control%20Room_core/ui/api_dashboard.js?v=20260218g"></script>

  <!-- Core Entity System -->
  <script src="js/core/icon_system.js"></script>
  <script src="js/core/entity_store.js"></script>
  <script src="js/core/entity_renderer.js"></script>
  <script src="js/core/ingestion_pipeline.js"></script>
  <script src="js/core/entity_search.js"></script>
  <script src="js/core/streetview.js?v=20260220a"></script>

  <!-- API Modules -->
  <script src="js/ch_api.js"></script>
  <script src="js/psc_api.js"></script>

  <!-- Icons -->
  <script src="js/icons.js"></script>

  <!-- Map -->
  <script src="js/map.js?v=20260218l"></script>

  <!-- Live Data Layers -->
  <script src="js/tfl_live.js"></script>
  <script src="js/national_rail_live.js"></script>
  <script src="js/flights.js"></script>
  <script src="js/dvla.js"></script>
  <script src="js/system_health.js"></script>
  <script src="js/i2_workspace.js"></script>

  <!-- Intelligence Dashboard Modules -->
  <script src="js/dashboard.js"></script>
  <script src="js/network_graph.js"></script>
  <script src="js/timeline.js"></script>
  <script src="js/context_menu.js"></script>
  <script src="js/intel_export.js"></script>
  <script src="js/intel_import.js"></script>
  <script src="js/doc_converter.js"></script>
  <script src="js/ux_assistant.js?v=20260220a"></script>
  <script src="js/sw-register.js"></script>

  <!-- Entity Inspector + Search Init -->
  <script>
    // Inspector panel logic
    window.openEntityInspector = function(entityId) {
      const panel = document.getElementById("entity-inspector");
      if (!panel || !window.EntityStore) return;
      const entity = window.EntityStore.getEntity(entityId);
      if (!entity) {
        // Try legacy
        const legacy = (window._mapEntities || []).find(e => e.id === entityId);
        if (!legacy) return;
      }
      const e = entity || {};
      const typeDef = window.EntityStore.ENTITY_TYPES[e.type];
      const badge = document.getElementById("inspector-type-badge");
      if (badge) { badge.textContent = typeDef?.label || e.type || "Entity"; badge.style.background = typeDef?.color || "#64748b"; }
      document.getElementById("inspector-label").textContent = e.label || "Unknown";

      // Attributes
      const tbody = document.querySelector("#inspector-attrs tbody");
      if (tbody) {
        let rows = "";
        const attrs = e.attributes || {};
        Object.keys(attrs).forEach(k => {
          if (attrs[k]) rows += `<tr><td>${k.replace(/_/g, " ")}</td><td>${String(attrs[k]).substring(0, 120)}</td></tr>`;
        });
        if (e.latLng) rows += `<tr><td>Lat/Lng</td><td>${e.latLng[0]?.toFixed(5)}, ${e.latLng[1]?.toFixed(5)}</td></tr>`;
        tbody.innerHTML = rows || "<tr><td colspan='2'>No attributes</td></tr>";
      }

      // Source
      const srcEl = document.getElementById("inspector-source");
      if (srcEl) {
        if (e.source?.documentId) {
          const doc = window.EntityStore.getEntity(e.source.documentId);
          srcEl.innerHTML = `<span class="popup-tag" style="background:#475569">${doc?.label || e.source.documentId}</span>` +
            (e.source.method ? ` [${e.source.method}]` : "") +
            (e.source.confidence ? ` (${e.source.confidence})` : "");
        } else srcEl.textContent = "Manual placement";
      }

      // Relationships
      const relEl = document.getElementById("inspector-relationships");
      if (relEl) {
        const rels = window.EntityStore.getRelationshipsFor(entityId);
        if (rels.length) {
          relEl.innerHTML = rels.map(r => {
            const relType = window.EntityStore.RELATIONSHIP_TYPES[r.type];
            const other = r.fromId === entityId ? window.EntityStore.getEntity(r.toId) : window.EntityStore.getEntity(r.fromId);
            const dir = r.fromId === entityId ? "→" : "←";
            return `<li><span class="inspector-rel-type" style="background:${relType?.color || '#64748b'}">${(relType?.label || r.type).replace(/_/g, " ")}</span> ${dir} ${other?.label || "?"}</li>`;
          }).join("");
        } else relEl.innerHTML = "<li>None</li>";
      }

      // Street View
      const svEl = document.getElementById("inspector-streetview");
      if (svEl && e.latLng && window.StreetView) {
        window.StreetView.renderThumbnail(svEl, e.latLng[0], e.latLng[1]);
      } else if (svEl) svEl.innerHTML = "";

      // Wire action buttons
      document.getElementById("inspector-edit-btn").onclick = () => { if (typeof editEntity === "function") editEntity(entityId); };
      document.getElementById("inspector-connect-btn").onclick = () => { if (typeof drawConnectionFrom === "function") drawConnectionFrom(entityId); };
      document.getElementById("inspector-remove-btn").onclick = () => { if (typeof removeEntity === "function") removeEntity(entityId); panel.classList.remove("open"); };

      panel.classList.add("open");
      panel._currentEntityId = entityId;
    };
    document.getElementById("inspector-close-btn")?.addEventListener("click", () => {
      document.getElementById("entity-inspector")?.classList.remove("open");
    });

    // Init entity search when DOM is ready
    if (window.EntitySearch) window.EntitySearch.init();
  </script>

  <!-- Wire KPI bar action buttons -->
  <script>
    // Dynamic panel title — updates when tab changes
    const _tabTitles = { search: "SEARCH", entities: "ENTITIES", layers: "LAYERS" };
    document.addEventListener("controlroom:tabchange", (e) => {
      const titleEl = document.getElementById("cp-title");
      if (titleEl) titleEl.textContent = _tabTitles[e.detail?.tab] || "OPERATIONS";
    });

    document.getElementById("kpi-btn-save")?.addEventListener("click", () => {
      if (window.CRDashboard) window.CRDashboard.saveWorkspace("quicksave");
    });
    document.getElementById("kpi-btn-report")?.addEventListener("click", () => {
      if (typeof window.generate3x5x2Report === "function") window.generate3x5x2Report();
    });
    document.getElementById("kpi-btn-anx")?.addEventListener("click", () => {
      if (typeof window.exportI2ANX === "function") window.exportI2ANX();
    });
    document.getElementById("kpi-btn-excel")?.addEventListener("click", () => {
      if (typeof window.exportStructuredExcel === "function") window.exportStructuredExcel();
    });
    document.getElementById("kpi-btn-help")?.addEventListener("click", () => {
      if (window.CRDashboard) window.CRDashboard.showShortcutsOverlay();
    });

    // Control-panel command strip
    (function bindCommandStrip() {
      const openTab = (tabId) => {
        document.getElementById(`cp-tab-btn-${tabId}`)?.click();
      };
      document.getElementById("cp-cmd-search")?.addEventListener("click", () => {
        openTab("search");
        document.getElementById("ch_name")?.focus();
      });
      document.getElementById("cp-cmd-place")?.addEventListener("click", () => {
        openTab("entities");
        if (typeof window.startI2EntityPlacement === "function") {
          const categories = Object.keys(window.ICON_CATEGORIES || {});
          if (categories.length) {
            window.startI2EntityPlacement(categories[0]);
            window.showToast?.("Select a map point to place the new entity", "info");
            return;
          }
        }
        document.getElementById("entity-category")?.focus();
      });
      document.getElementById("cp-cmd-crime")?.addEventListener("click", () => {
        openTab("layers");
        document.getElementById("crime-force-filter")?.focus();
      });
      document.getElementById("cp-cmd-layers")?.addEventListener("click", () => {
        openTab("layers");
      });
    })();
    // Search source categories
    (function wireSearchSourceTabs() {
      const paneRoot = document.getElementById("tab-search");
      if (!paneRoot) return;
      const tabs = Array.from(paneRoot.querySelectorAll(".ops-source-tab"));
      const panes = Array.from(paneRoot.querySelectorAll(".ops-source-pane"));
      if (!tabs.length || !panes.length) return;
      let activeKey = "companies";

      const focusByPane = {
        companies: "ch_name",
        people: "psc_name",
        land: "lr-postcode",
        disqualified: "dq-name",
        charity: "charity-name",
        mostwanted: "mostwanted-name",
        sanvessel: "sanvessel-name",
        vehicle: "dvla-vrm-input",
      };

      function activate(key, shouldFocus) {
        const target = String(key || "").trim();
        activeKey = target || "";
        tabs.forEach((btn) => {
          btn.classList.toggle("active", btn.getAttribute("data-ops-tab") === target);
        });
        panes.forEach((pane) => {
          pane.classList.toggle("active", pane.getAttribute("data-ops-pane") === target);
        });
        if (shouldFocus) {
          const id = focusByPane[target];
          if (id) document.getElementById(id)?.focus();
        }
      }

      function collapseAll() {
        activeKey = "";
        tabs.forEach((btn) => btn.classList.remove("active"));
        panes.forEach((pane) => pane.classList.remove("active"));
      }

      tabs.forEach((btn) => {
        btn.addEventListener("click", () => {
          const key = btn.getAttribute("data-ops-tab");
          if (key && key === activeKey) {
            collapseAll();
            return;
          }
          activate(key, true);
        });
      });
      activate("companies", false);
    })();
    // Wire Land Registry search
    document.getElementById("lr-search-btn")?.addEventListener("click", async () => {
      const pc = document.getElementById("lr-postcode")?.value?.trim();
      if (!pc) return;
      const results = await window.searchLandRegistry(pc);
      const container = document.getElementById("lr-results");
      if (!container) return;
      if (!results.length) { container.innerHTML = '<div class="nr-empty">No transactions found.</div>'; return; }
      container.innerHTML = results.map(r => `<div class="ch-result-item">
        <div class="ch-r-name">${r.address || "Unknown"}</div>
        <div class="ch-r-detail">&pound;${Number(r.price).toLocaleString()} &middot; ${r.date || ""} &middot; ${r.type || ""}</div>
      </div>`).join("");
    });
    // Wire Disqualified Directors search
    document.getElementById("dq-search-btn")?.addEventListener("click", async () => {
      const name = document.getElementById("dq-name")?.value?.trim();
      if (!name) return;
      const results = await window.searchDisqualifiedDirectors(name);
      const container = document.getElementById("dq-results");
      if (!container) return;
      if (!results.length) { container.innerHTML = '<div class="nr-empty">No disqualified directors found.</div>'; return; }
      container.innerHTML = results.map(r => `<div class="ch-result-item">
        <div class="ch-r-name" style="color:#ef4444">${r.name || "Unknown"}</div>
        <div class="ch-r-detail">DOB: ${r.dateOfBirth || "N/A"} &middot; ${r.address || ""}</div>
        <div class="ch-r-detail">Disqualified: ${r.disqualifiedFrom || "?"} to ${r.disqualifiedUntil || "?"}</div>
        ${r.snippet ? `<div class="ch-r-detail" style="color:#fbbf24">${r.snippet}</div>` : ""}
      </div>`).join("");
    });

    // Wire Charity Commission search
    document.getElementById("charity-search-btn")?.addEventListener("click", async () => {
      const name = document.getElementById("charity-name")?.value?.trim();
      if (!name) return;
      const results = await window.searchCharities(name);
      const container = document.getElementById("charity-results");
      if (!container) return;
      if (!results.length) { container.innerHTML = '<div class="nr-empty">No charities found.</div>'; return; }
      container.innerHTML = results.map(r => `<div class="ch-result-item">
        <div class="ch-r-name" style="color:#22c55e">${r.name || "Unknown"}</div>
        <div class="ch-r-detail">Reg: ${r.number || "N/A"} &middot; Status: ${r.status || "Unknown"}</div>
        ${r.activities ? `<div class="ch-r-detail">${r.activities.slice(0,120)}</div>` : ""}
      </div>`).join("");
    });

    // Wire local NCA Most Wanted search
    (function wireMostWantedSearch() {
      const qInput = document.getElementById("mostwanted-name");
      const searchBtn = document.getElementById("mostwanted-search-btn");
      const clearBtn = document.getElementById("mostwanted-clear-btn");
      const metaEl = document.getElementById("mostwanted-meta");
      const resultsEl = document.getElementById("mostwanted-results");
      const sidePanelEl = document.getElementById("mostwanted-side-panel");
      const sideMetaEl = document.getElementById("mostwanted-side-meta");
      const sideResultsEl = document.getElementById("mostwanted-side-results");
      const sideCloseBtn = document.getElementById("mostwanted-side-close");

      let dataset = null;
      let loadingPromise = null;
      let inputTimer = null;
      const mostWantedTownCache = new Map();
      const SMALL_DATASET_MAX = 50;
      const MW_MONTH_WORDS = new Set([
        "january", "february", "march", "april", "may", "june",
        "july", "august", "september", "october", "november", "december"
      ]);
      const MW_NON_PLACE_WORDS = new Set([
        "operation", "proceeds", "crime", "class", "cash", "control", "retention",
        "acquisition", "property", "police", "court", "bail", "fraud", "drugs",
        "heroin", "cocaine", "cannabis", "offence", "offences"
      ]);

      function setSidePanelOpen(open) {
        if (!sidePanelEl) return;
        sidePanelEl.classList.toggle("hidden", !open);
      }

      function syncSideMeta(text) {
        if (sideMetaEl) sideMetaEl.textContent = String(text || "");
      }

      function normalizeText(value) {
        return String(value || "").toLowerCase().replace(/\s+/g, " ").trim();
      }

      function esc(value) {
        return String(value || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      function flattenValue(value, out, limit = 120) {
        if (out.length >= limit || value == null) return;
        if (typeof value === "string" || typeof value === "number" || typeof value === "boolean") {
          const s = String(value).trim();
          if (s) out.push(s);
          return;
        }
        if (Array.isArray(value)) {
          for (const item of value) {
            flattenValue(item, out, limit);
            if (out.length >= limit) break;
          }
          return;
        }
        if (typeof value === "object") {
          for (const v of Object.values(value)) {
            flattenValue(v, out, limit);
            if (out.length >= limit) break;
          }
        }
      }

      function parseJsonl(text) {
        const rows = [];
        for (const raw of String(text || "").split(/\r?\n/)) {
          const line = raw.trim();
          if (!line) continue;
          try {
            rows.push(JSON.parse(line));
          } catch (_) {
            // ignore malformed lines
          }
        }
        return rows;
      }

      function normalizeRecord(raw) {
        const props = raw && typeof raw.properties === "object" ? raw.properties : {};
        const name = raw?.caption || raw?.name || props?.name?.[0] || "Unknown";
        const notes = Array.isArray(props?.notes) ? props.notes : (props?.notes ? [String(props.notes)] : []);
        const aliases = [];
        for (const key of ["alias", "aliases"]) {
          const v = props?.[key];
          if (Array.isArray(v)) aliases.push(...v);
          else if (typeof v === "string") aliases.push(v);
        }
        const fields = [];
        flattenValue(raw, fields, 160);
        return {
          id: String(raw?.id || ""),
          name: String(name || "Unknown"),
          notes: notes.map(x => String(x)),
          aliases: aliases.map(x => String(x)),
          url: String(props?.sourceUrl?.[0] || props?.sourceUrl || ""),
          snippet: fields.join(" | ").slice(0, 320),
          _search: normalizeText(fields.join(" ")),
          _raw: raw,
        };
      }

      async function loadDataset() {
        if (Array.isArray(dataset)) return dataset;
        if (loadingPromise) return loadingPromise;
        const candidates = [
          "/data/watchlists/UK NCA Most Wanted.jsonl",
          "/data/watchlists/UK NCA Most Wanted.json",
        ];
        loadingPromise = (async () => {
          for (const path of candidates) {
            try {
              const resp = await fetch(path, { headers: { Accept: "application/json,text/plain" } });
              if (!resp.ok) continue;
              const text = await resp.text();
              const rows = parseJsonl(text).map(normalizeRecord).filter(r => r._search);
              if (rows.length) {
                dataset = rows;
                if (metaEl) {
                  metaEl.textContent = `${rows.length.toLocaleString()} records ready`;
                }
                return rows;
              }
            } catch (_) {
              // try next path
            }
          }
          dataset = [];
          if (metaEl) metaEl.textContent = "Dataset unavailable";
          return dataset;
        })();
        return loadingPromise;
      }

      function scoreMatch(row, qNorm, tokens) {
        if (!qNorm || !row?._search) return -1;
        if (row._search.includes(qNorm)) return 3;
        if (tokens.length && tokens.every(t => row._search.includes(t))) return 2;
        return -1;
      }

      function buildMostWantedI2EntityData(row, options = {}) {
        const raw = row && typeof row._raw === "object" ? row._raw : {};
        const nameParts = splitPersonName(row?.name || "");
        const insights = options.insights || {};
        const values = [];
        const push = (propertyName, value) => {
          const v = String(value || "").trim();
          if (!v) return;
          values.push({ propertyName, value: v });
        };

        // Align with existing person/officer i2 profile fields so edit/view flows remain consistent.
        push("Full Name", row.name);
        push("First Name", nameParts.firstName);
        push("Surname", nameParts.surname);
        push("Role", "Most Wanted");
        push("Date of Birth", options.dobValue || metadataValue(raw, "dob"));
        push("Age", options.ageValue || "");
        push("Nationality", metadataValue(raw, "nationality"));
        push("Country of Residence", metadataValue(raw, "countryOfResidence"));
        push("Gender", metadataValue(raw, "gender"));
        push("Ethnicity", metadataValue(raw, "ethnicity"));
        push("Hair Color", metadataValue(raw, "hairColor"));
        push("Height", metadataValue(raw, "height"));
        push("Address String", options.locationLabel || "");
        push("Alias", options.aliasesValue || (Array.isArray(row.aliases) ? row.aliases.join(", ") : ""));
        push("Criminality", insights.criminality || "");
        push("Timeline", insights.yearSpans || "");
        push("Victims", insights.victimCount || "");
        push("Financial Detail", insights.moneyMentions || "");
        push("Topics", metadataValue(raw, "topics"));
        push("Most Wanted ID", row.id);
        push("UID", row.id);
        push("Source URL", row.url || "");
        push("Dataset", "UK NCA Most Wanted");
        push("Notes", Array.isArray(row.notes) && row.notes.length ? row.notes.join(" | ") : (row.snippet || ""));

        return {
          entityType: "Person",
          entityName: "Person",
          entityId: "ET5",
          values
        };
      }

      function mapCenterLatLng() {
        if (window._map && typeof window._map.getCenter === "function") {
          const c = window._map.getCenter();
          return [Number(c.lat), Number(c.lng)];
        }
        return [51.5074, -0.1278];
      }

      function londonLatLng() {
        return [51.5074, -0.1278];
      }

      function inferMostWantedAddressPreview(row) {
        const raw = row && typeof row._raw === "object" ? row._raw : {};
        const explicitAddress = metadataValue(raw, "address");
        if (explicitAddress) return explicitAddress;
        const places = collectUkTownCandidates(row);
        if (!places.length) return "";
        return `${places[0]}, UK`;
      }

      function buildMostWantedPrimaryDetails(row) {
        const raw = row && typeof row._raw === "object" ? row._raw : {};
        const details = [];
        const add = (label, value) => {
          const text = String(value || "").trim();
          if (!text) return;
          details.push({ label, value: text });
        };

        add("Gender", metadataValue(raw, "gender"));
        add("Ethnicity", metadataValue(raw, "ethnicity"));
        add("Hair", metadataValue(raw, "hairColor"));
        add("Height", metadataValue(raw, "height"));
        add("Address", inferMostWantedAddressPreview(row));

        return details;
      }

      function renderRows(rows, modeLabel = "") {
        if (!sideResultsEl) return;
        if (!rows.length) {
          sideResultsEl.innerHTML = '<div class="nr-empty">No Most Wanted matches found.</div>';
          setSidePanelOpen(true);
          syncSideMeta(modeLabel || "No matching records.");
          return;
        }
        sideResultsEl.innerHTML = rows.map(r => {
          const insights = getMostWantedInsights(r);
          const dobAge = buildMostWantedDobAgeLabel(r);
          return `<div class="ch-result-item" data-mw-id="${esc(r.id)}">
          <div class="ch-r-name" style="color:#f59e0b">${esc(r.name)}</div>
          ${dobAge ? `<div class="ch-r-detail"><span class="popup-label">${esc(dobAge)}</span></div>` : ""}
          ${buildMostWantedPrimaryDetails(r).map(d => `<div class="ch-r-detail"><span class="popup-label">${esc(d.label)}</span> ${esc(d.value)}</div>`).join("")}
          ${r.aliases.length ? `<div class="ch-r-detail"><span class="popup-label">Aliases</span> ${esc(r.aliases.slice(0, 4).join(", "))}</div>` : ""}
          ${insights.aliases.length ? `<div class="ch-r-detail"><span class="popup-label">Parsed Alias</span> ${esc(insights.aliases.slice(0, 4).join(", "))}</div>` : ""}
          ${insights.criminality ? `<div class="ch-r-detail"><span class="popup-label">Criminality</span> ${esc(insights.criminality)}</div>` : ""}
          ${insights.yearSpans ? `<div class="ch-r-detail"><span class="popup-label">Years</span> ${esc(insights.yearSpans)}</div>` : ""}
          ${insights.victimCount ? `<div class="ch-r-detail"><span class="popup-label">Victims</span> ${esc(insights.victimCount)}</div>` : ""}
          ${insights.moneyMentions ? `<div class="ch-r-detail"><span class="popup-label">Money</span> ${esc(insights.moneyMentions)}</div>` : ""}
          ${r.notes.length ? `<div class="ch-r-detail"><span class="popup-label">Notes</span> ${esc(r.notes[0])}</div>` : `<div class="ch-r-detail"><span class="popup-label">Notes</span> ${esc(r.snippet)}</div>`}
          ${r.url ? `<div class="ch-r-detail"><a href="${esc(r.url)}" target="_blank" rel="noopener noreferrer">Source page</a></div>` : ""}
          <div class="cp-btn-row" style="margin-top:6px">
            <button type="button" class="btn-secondary btn-sm" data-mw-select="${esc(r.id)}">Select</button>
            <button type="button" class="btn-primary btn-sm" data-mw-add="${esc(r.id)}">Add Person</button>
          </div>
        </div>`;
        }).join("");
        setSidePanelOpen(true);
        syncSideMeta(modeLabel || `${rows.length} result(s)`);
        if (resultsEl) {
          resultsEl.innerHTML = '<div class="nr-empty">Results moved to the right panel for readability.</div>';
        }
      }

      function metadataValue(raw, key) {
        const props = raw && typeof raw.properties === "object" ? raw.properties : {};
        const v = props[key];
        if (Array.isArray(v)) return v.filter(Boolean).map(String).join(", ");
        if (v == null) return "";
        return String(v);
      }

      function splitPersonName(fullName) {
        const name = String(fullName || "").trim();
        if (!name) return { firstName: "", surname: "" };
        const parts = name.split(/\s+/).filter(Boolean);
        if (parts.length <= 1) return { firstName: name, surname: "" };
        return {
          firstName: parts[0],
          surname: parts.slice(1).join(" ")
        };
      }

      function extractAgeHint(text) {
        const value = String(text || "");
        if (!value) return null;
        const patterns = [
          /\b(?:he|she|they|[A-Z][a-z]+)\s+is\s+(?:around|about|approximately|approx\.?)?\s*(\d{1,2})\s*(?:years?\s*old|yrs?\s*old|yr\s*old|y\/o)\b/i,
          /\baged\s+(\d{1,2})\b/i,
          /\b(?:around|about|approximately|approx\.?)\s*(\d{1,2})\s*(?:years?\s*old|yrs?\s*old|yr\s*old|y\/o)\b/i
        ];
        for (const re of patterns) {
          const m = value.match(re);
          if (!m) continue;
          const age = Number(m[1]);
          if (Number.isFinite(age) && age >= 12 && age <= 100) return age;
        }
        return null;
      }

      function inferAgeFromMostWanted(row) {
        const notes = Array.isArray(row?.notes) ? row.notes : [];
        for (const note of notes) {
          const age = extractAgeHint(note);
          if (age != null) return age;
        }
        return extractAgeHint(row?.snippet || "");
      }

      function estimateDobFromAge(age) {
        if (!Number.isFinite(age)) return null;
        const currentYear = new Date().getFullYear();
        const fromYear = currentYear - age - 1;
        const toYear = currentYear - age;
        if (!Number.isFinite(fromYear) || !Number.isFinite(toYear)) return null;
        return {
          range: `${fromYear}-${toYear}`,
          label: `${fromYear}-${toYear} (estimated from age ${age})`
        };
      }

      function extractAllMatches(text, regex, groupIndex = 1) {
        const out = [];
        if (!text || !(regex instanceof RegExp)) return out;
        const source = String(text);
        const flags = regex.flags.includes("g") ? regex.flags : `${regex.flags}g`;
        const re = new RegExp(regex.source, flags);
        let m = null;
        while ((m = re.exec(source))) {
          const val = String(m[groupIndex] || "").trim();
          if (val) out.push(val);
        }
        return out;
      }

      function extractMostWantedInsights(row) {
        const notesText = Array.isArray(row?.notes) && row.notes.length
          ? row.notes.join(" | ")
          : String(row?.snippet || "");
        const text = String(notesText || "");
        if (!text) return { aliases: [], criminality: "", yearSpans: "", victimCount: "", moneyMentions: "" };

        const aliases = [];
        aliases.push(...extractAllMatches(text, /\balias(?:es)?\s+(?:of\s+)?['"]?([A-Z][A-Za-z'’\-]+(?:\s+[A-Z][A-Za-z'’\-]+){0,5})['"]?/i));
        aliases.push(...extractAllMatches(text, /\b(?:also known as|known as|nickname)\s+['"]?([A-Z][A-Za-z'’\-]+(?:\s+[A-Z][A-Za-z'’\-]+){0,5})['"]?/i));

        const lower = text.toLowerCase();
        const criminalityMap = [
          ["fraud", "Fraud"],
          ["murder", "Murder"],
          ["rape", "Rape"],
          ["wounding", "Wounding"],
          ["assault", "Assault"],
          ["heroin", "Drug Offence"],
          ["cocaine", "Drug Offence"],
          ["cannabis", "Drug Offence"],
          ["diamorphine", "Drug Offence"],
          ["supply class a", "Drug Supply"],
          ["money laundering", "Money Laundering"],
          ["proceeds of crime", "Money Laundering"],
          ["insider dealing", "Insider Dealing"],
          ["dangerous driving", "Dangerous Driving"],
          ["conspiracy", "Conspiracy"],
          ["theft", "Theft"]
        ];
        const criminality = uniqueStrings(
          criminalityMap.filter(([k]) => lower.includes(k)).map(([, v]) => v)
        ).join(", ");

        const yearSpanMatches = [
          ...extractAllMatches(text, /\b((?:19|20)\d{2}\s*(?:-|to|and)\s*(?:19|20)\d{2})\b/i),
          ...extractAllMatches(text, /\bbetween\s+((?:19|20)\d{2}\s+and\s+(?:19|20)\d{2})\b/i)
        ];
        const yearSpans = uniqueStrings(yearSpanMatches).join(", ");

        const victimCountMatch = text.match(/\b(\d{1,3}(?:,\d{3})+|\d+)\s+people\b/i);
        const victimCount = victimCountMatch ? victimCountMatch[1] : "";

        const moneyMentions = uniqueStrings(
          extractAllMatches(text, /([£€$]\s?\d[\d,]*(?:\.\d+)?\s*(?:million|billion|bn|k|thousand)?)/i)
        ).join(", ");

        return { aliases: uniqueStrings(aliases), criminality, yearSpans, victimCount, moneyMentions };
      }

      const mostWantedInsightsCache = new Map();
      function getMostWantedInsights(row) {
        const key = String(row?.id || "");
        if (key && mostWantedInsightsCache.has(key)) return mostWantedInsightsCache.get(key);
        const insights = extractMostWantedInsights(row);
        if (key) mostWantedInsightsCache.set(key, insights);
        return insights;
      }

      function buildMostWantedDobAgeLabel(row) {
        const raw = row && typeof row._raw === "object" ? row._raw : {};
        const dob = metadataValue(raw, "dob");
        if (dob) return `DOB ${dob}`;
        const age = inferAgeFromMostWanted(row);
        if (age != null) return `Age ${age}`;
        return "";
      }

      function offsetLatLng(origin, index = 0) {
        const base = Array.isArray(origin) && origin.length >= 2 ? origin : londonLatLng();
        const angle = (index % 8) * (Math.PI / 4);
        const radius = 0.002 + (Math.floor(index / 8) * 0.0012);
        return [
          Number(base[0]) + Math.sin(angle) * radius,
          Number(base[1]) + Math.cos(angle) * radius
        ];
      }

      function parseVictimMentions(text, suspectName = "") {
        const out = [];
        const source = String(text || "");
        if (!source) return out;
        const selfKey = normalizeText(suspectName || "");
        const seen = new Set();
        const pushVictim = (nameRaw, yearRaw = "") => {
          const name = String(nameRaw || "").trim();
          const year = String(yearRaw || "").trim();
          const key = normalizeText(name);
          if (!name || key === selfKey || seen.has(key)) return;
          seen.add(key);
          out.push({ name, year, relation: year ? `Murdered (${year})` : "Murdered" });
        };

        const patterns = [
          // "murder of Thomas Cameron on 28 June 2007"
          /\bmurder(?:ed)?\s+(?:of|involving)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+){1,3})(?:\s+on\s+\d{1,2}\s+[A-Z][a-z]+\s+((?:19|20)\d{2}))?/gi,
          // "murders of Liam Kelly in 2004"
          /\bmurders?\s+of\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+){1,3})(?:\s+in\s+((?:19|20)\d{2}))?/gi,
          // legacy fallback: "Thomas Cameron in 2007"
          /\b([A-Z][a-z]+(?:\s+[A-Z][a-z]+){1,3})\s+in\s+((?:19|20)\d{2})\b/g
        ];

        patterns.forEach((re) => {
          let match = null;
          while ((match = re.exec(source))) {
            pushVictim(match[1], match[2]);
          }
        });

        return out;
      }

      function parseCommodityMentions(text) {
        const source = String(text || "").toLowerCase();
        if (!source) return [];
        const keywords = [
          "heroin", "cocaine", "cannabis", "diamorphine", "mdma", "lsd", "diazepam",
          "class a drugs", "drugs"
        ];
        return uniqueStrings(keywords.filter((k) => source.includes(k)).map((k) => {
          if (k === "class a drugs") return "Class A Drugs";
          if (k === "mdma") return "MDMA";
          if (k === "lsd") return "LSD";
          return k.charAt(0).toUpperCase() + k.slice(1);
        }));
      }

      function ensurePersonEntityByName(name, latLng, sourceInfo) {
        if (!window.EntityStore || !window.EntityRenderer) return null;
        const targetName = String(name || "").trim();
        if (!targetName) return null;
        const existing = (window.EntityStore.getAll?.() || []).find((e) => {
          if (e?.type !== "person") return false;
          const full = String(e?.attributes?.fullName || e?.label || "");
          return normalizeText(full) === normalizeText(targetName);
        });
        if (existing?.id) return existing.id;

        return window.EntityRenderer.placeEntityViaStore(
          "person",
          targetName,
          latLng,
          {
            sourceType: "most_wanted_notes",
            fullName: targetName,
            notes: "Auto-created from Most Wanted notes"
          },
          sourceInfo || { method: "most_wanted_notes", confidence: "low" },
          {
            entityType: "Person",
            entityName: "Person",
            entityId: "ET5",
            values: [{ propertyName: "Full Name", value: targetName }]
          },
          "gfx/map_icons/people/man.png"
        );
      }

      function ensureEventEntity(label, latLng, attributes, sourceInfo) {
        if (!window.EntityStore || !window.EntityRenderer) return null;
        const targetLabel = String(label || "").trim();
        if (!targetLabel) return null;
        const existing = (window.EntityStore.getAll?.() || []).find((e) => {
          if (e?.type !== "event") return false;
          return normalizeText(String(e?.label || "")) === normalizeText(targetLabel);
        });
        if (existing?.id) return existing.id;

        return window.EntityRenderer.placeEntityViaStore(
          "event",
          targetLabel,
          latLng,
          attributes || {},
          sourceInfo || { method: "most_wanted_notes", confidence: "low" },
          null,
          "danger"
        );
      }

      function ensureRelationship(fromId, toId, label, type = "linked_to") {
        if (!window.EntityStore || !fromId || !toId) return null;
        const rels = window.EntityStore.getRelationshipsFor?.(fromId) || [];
        const exists = rels.some((r) => {
          const sameDirection = (r.fromId === fromId && r.toId === toId) || (r.fromId === toId && r.toId === fromId);
          return sameDirection && normalizeText(r.label || "") === normalizeText(label || "");
        });
        if (exists) return null;
        return window.EntityStore.addRelationship({
          type,
          fromId,
          toId,
          label: String(label || "").trim() || undefined,
          source: { method: "most_wanted_notes", confidence: "low" }
        });
      }

      function addDerivedEntitiesFromNotes(mainEntityId, row, baseLatLng) {
        if (!mainEntityId || !row) return;
        const text = Array.isArray(row.notes) && row.notes.length ? row.notes.join(" | ") : String(row.snippet || "");
        const sourceInfo = { method: "most_wanted_notes", confidence: "low" };

        const victims = parseVictimMentions(text, row.name);
        victims.forEach((v, idx) => {
          const victimId = ensurePersonEntityByName(v.name, offsetLatLng(baseLatLng, idx + 1), sourceInfo);
          if (victimId) ensureRelationship(mainEntityId, victimId, v.relation || "Associated with", "associated_with");
        });

        const commodities = parseCommodityMentions(text);
        commodities.forEach((commodity, idx) => {
          const evId = ensureEventEntity(
            `Commodity: ${commodity}`,
            offsetLatLng(baseLatLng, 20 + idx),
            {
              sourceType: "most_wanted_notes",
              type: "Commodity",
              subtype: "commodity",
              description: commodity
            },
            sourceInfo
          );
          if (evId) ensureRelationship(mainEntityId, evId, `Commodity: ${commodity}`, "linked_to");
        });
      }

      function uniqueStrings(values) {
        const seen = new Set();
        const out = [];
        for (const value of values || []) {
          const v = String(value || "").trim();
          if (!v) continue;
          const key = v.toLowerCase();
          if (seen.has(key)) continue;
          seen.add(key);
          out.push(v);
        }
        return out;
      }

      function extractLikelyUkPlaces(text) {
        const value = String(text || "");
        if (!value) return [];
        const stopwords = new Set([
          "the", "and", "or", "for", "with", "without", "against", "wanted",
          "majorca", "madrid", "spain", "serbia", "india", "iraq", "turkish", "cypriot",
          "uk", "united", "kingdom", "england", "scotland", "wales", "ireland", "channel"
        ]);
        const out = [];
        const patterns = [
          /\b(?:in|at|near|around|from)\s+([A-Z][a-z]+(?:[\s-][A-Z][a-z]+){0,2})/g,
          /\b(?:born in|murders in|links to|area when he crashed in)\s+([A-Z][a-z]+(?:[\s-][A-Z][a-z]+){0,2})/g
        ];
        for (const re of patterns) {
          let match = null;
          while ((match = re.exec(value))) {
            const candidate = String(match[1] || "").replace(/^[\s,.;:'"()\-]+|[\s,.;:'"()\-]+$/g, "").trim();
            if (!candidate || /\d/.test(candidate)) continue;
            const tokens = candidate.toLowerCase().split(/[\s-]+/).filter(Boolean);
            if (!tokens.length || tokens.every(t => stopwords.has(t))) continue;
            if (tokens.some(t => stopwords.has(t)) && tokens.length === 1) continue;
            if (tokens.some(t => MW_MONTH_WORDS.has(t))) continue;
            if (tokens.every(t => MW_NON_PLACE_WORDS.has(t))) continue;
            out.push(candidate);
          }
        }
        return uniqueStrings(out);
      }

      function collectUkTownCandidates(row) {
        const notes = Array.isArray(row?.notes) ? row.notes : [];
        const fromNotes = notes.flatMap(extractLikelyUkPlaces);
        const fromSnippet = extractLikelyUkPlaces(row?.snippet || "");
        return uniqueStrings([...fromNotes, ...fromSnippet]).slice(0, 8);
      }

      async function resolveMostWantedPlacement(row) {
        const geocodeFn = (typeof window.geocodeAddress === "function")
          ? window.geocodeAddress
          : ((typeof globalThis.geocodeAddress === "function") ? globalThis.geocodeAddress : null);
        if (!geocodeFn) return null;

        const candidates = collectUkTownCandidates(row);
        for (const town of candidates) {
          const key = town.toLowerCase();
          if (mostWantedTownCache.has(key)) {
            const cached = mostWantedTownCache.get(key);
            if (cached) return { ...cached, matchedTown: town };
            continue;
          }
          let coords = null;
          try {
            coords = await geocodeFn(`${town}, United Kingdom`, { strict: false });
          } catch (_) {
            coords = null;
          }
          if (coords && Number.isFinite(coords.lat) && Number.isFinite(coords.lon)) {
            const resolved = {
              latLng: [Number(coords.lat), Number(coords.lon)],
              locationLabel: `${town}, UK`
            };
            mostWantedTownCache.set(key, resolved);
            return { ...resolved, matchedTown: town };
          }
          mostWantedTownCache.set(key, null);
        }
        return null;
      }

      async function addMostWantedToStore(recordId) {
        const rows = await loadDataset();
        const row = rows.find(r => String(r.id) === String(recordId));
        if (!row) return;
        if (!window.EntityStore || !window.EntityRenderer) {
          if (typeof window.showToast === "function") window.showToast("Entity store is unavailable", "error", 2500);
          return;
        }

        const existing = (window.EntityStore.getAll?.() || []).find((e) => {
          const attrs = e?.attributes || {};
          return String(attrs.mostWantedId || "") === String(row.id || "");
        });
        if (existing?.id) {
          if (window._map && Array.isArray(existing.latLng)) {
            window._map.panTo(existing.latLng);
          }
          if (typeof window.showToast === "function") {
            window.showToast(`${row.name} already exists in entity store`, "info", 2200);
          }
          return;
        }

        const raw = row._raw || {};
        const topics = metadataValue(raw, "topics");
        const dob = metadataValue(raw, "dob");
        const nationality = metadataValue(raw, "nationality");
        const countryOfResidence = metadataValue(raw, "countryOfResidence");
        const gender = metadataValue(raw, "gender");
        const ethnicity = metadataValue(raw, "ethnicity");
        const hairColor = metadataValue(raw, "hairColor");
        const height = metadataValue(raw, "height");
        const inferredAge = inferAgeFromMostWanted(row);
        const estimatedDob = estimateDobFromAge(inferredAge);
        const dobDisplay = String(dob || estimatedDob?.label || "");
        const ageDisplay = inferredAge != null ? String(inferredAge) : "";
        const insights = getMostWantedInsights(row);
        const combinedAliases = uniqueStrings([...(row.aliases || []), ...(insights.aliases || [])]).join(", ");
        const placement = await resolveMostWantedPlacement(row);
        const locationLabel = String(placement?.locationLabel || "");
        const i2EntityData = buildMostWantedI2EntityData(row, {
          locationLabel,
          dobValue: dobDisplay,
          ageValue: ageDisplay,
          aliasesValue: combinedAliases,
          insights
        });
        const notesText = Array.isArray(row.notes) && row.notes.length ? row.notes.join(" | ") : (row.snippet || "");
        const nameParts = splitPersonName(row.name);
        const attributes = {
          sourceType: "most_wanted",
          fullName: row.name,
          firstName: nameParts.firstName,
          surname: nameParts.surname,
          mostWantedId: String(row.id || ""),
          aliases: combinedAliases,
          topics: topics || "",
          dob: dobDisplay,
          ageEstimate: ageDisplay,
          possibleDobYear: String(estimatedDob?.range || ""),
          criminality: insights.criminality || "",
          incidentYears: insights.yearSpans || "",
          victimCount: insights.victimCount || "",
          moneyMentions: insights.moneyMentions || "",
          nationality: nationality || "",
          countryOfResidence: countryOfResidence || "",
          officerRole: "Most Wanted",
          gender: gender || "",
          ethnicity: ethnicity || "",
          hairColor: hairColor || "",
          height: height || "",
          address: locationLabel,
          lastKnownTown: String(placement?.matchedTown || ""),
          notes: notesText,
          sourceUrl: String(row.url || ""),
          dataset: "UK NCA Most Wanted",
          uid: String(row.id || "")
        };
        const entityId = window.EntityRenderer.placeEntityViaStore(
          "person",
          row.name,
          Array.isArray(placement?.latLng) ? placement.latLng : londonLatLng(),
          attributes,
          { method: "most_wanted_local", confidence: "medium" },
          i2EntityData,
          "gfx/map_icons/people/man.png"
        );
        if (entityId) {
          const anchor = Array.isArray(placement?.latLng) ? placement.latLng : londonLatLng();
          addDerivedEntitiesFromNotes(entityId, row, anchor);
        }
        if (entityId && typeof window.showToast === "function") {
          if (locationLabel) {
            window.showToast(`Added ${row.name} near ${locationLabel}`, "success", 2400);
          } else {
            window.showToast(`Added ${row.name} to entity store`, "success", 2200);
          }
        }
      }

      async function runSearch() {
        if (!resultsEl) return;
        const q = String(qInput?.value || "").trim();
        resultsEl.innerHTML = '<div class="mostwanted-status inline">Searching...</div>';
        setSidePanelOpen(true);
        syncSideMeta("Searching...");
        if (sideResultsEl) sideResultsEl.innerHTML = '<div class="mostwanted-status inline">Searching...</div>';
        const rows = await loadDataset();
        if (!rows.length) {
          resultsEl.innerHTML = '<div class="nr-empty">Most Wanted dataset unavailable.</div>';
          if (sideResultsEl) sideResultsEl.innerHTML = '<div class="nr-empty">Most Wanted dataset unavailable.</div>';
          syncSideMeta("Dataset unavailable");
          return;
        }
        if (!q) {
          if (rows.length <= SMALL_DATASET_MAX) {
            renderRows(rows, `Select from ${rows.length} records or type to filter.`);
          } else {
            resultsEl.innerHTML = '<div class="nr-empty">Enter a search term.</div>';
          }
          return;
        }
        const qNorm = normalizeText(q);
        const tokens = qNorm.split(/[^a-z0-9]+/).filter(Boolean);
        const matched = rows
          .map(row => ({ row, score: scoreMatch(row, qNorm, tokens) }))
          .filter(x => x.score >= 0)
          .sort((a, b) => (b.score - a.score) || a.row.name.localeCompare(b.row.name))
          .slice(0, 50)
          .map(x => x.row);

        renderRows(matched, `Showing ${matched.length} result(s).`);
      }

      searchBtn?.addEventListener("click", runSearch);
      clearBtn?.addEventListener("click", () => {
        if (qInput) qInput.value = "";
        runSearch();
      });
      sideCloseBtn?.addEventListener("click", () => {
        setSidePanelOpen(false);
      });
      document.querySelectorAll(".ops-source-tab").forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.getAttribute("data-ops-tab");
          if (target !== "mostwanted") {
            setSidePanelOpen(false);
          } else if (String(sideResultsEl?.innerHTML || "").trim()) {
            setSidePanelOpen(true);
          }
        });
      });
      qInput?.addEventListener("keydown", (ev) => {
        if (ev.key !== "Enter") return;
        ev.preventDefault();
        runSearch();
      });
      qInput?.addEventListener("input", () => {
        if (inputTimer) clearTimeout(inputTimer);
        inputTimer = setTimeout(() => {
          runSearch();
        }, 120);
      });
      qInput?.addEventListener("focus", () => {
        if (!dataset && !loadingPromise) {
          loadDataset().then(() => runSearch());
          return;
        }
        if (!String(qInput?.value || "").trim()) runSearch();
      });
      sideResultsEl?.addEventListener("click", async (ev) => {
        const t = ev.target;
        if (!(t instanceof HTMLElement)) return;
        const pickId = t.getAttribute("data-mw-select");
        const addId = t.getAttribute("data-mw-add");
        const id = pickId || addId;
        if (!id) return;
        const rows = await loadDataset();
        const row = rows.find(r => String(r.id) === String(id));
        if (!row) return;
        if (pickId) {
          if (qInput) qInput.value = row.name;
          runSearch();
          return;
        }
        if (addId) {
          await addMostWantedToStore(id);
        }
      });
    })();

    // Wire local sanctioned vessels search
    (function wireSanctionedVesselsSearch() {
      const qInput = document.getElementById("sanvessel-name");
      const searchBtn = document.getElementById("sanvessel-search-btn");
      const clearBtn = document.getElementById("sanvessel-clear-btn");
      const highlightBtn = document.getElementById("sanvessel-highlight-btn");
      const metaEl = document.getElementById("sanvessel-meta");
      const resultsEl = document.getElementById("sanvessel-results");

      let dataset = null;
      let loadingPromise = null;
      let liveShipsPromise = null;
      let liveShips = [];
      let inputTimer = null;
      let highlightEnabled = false;
      const SMALL_DATASET_MAX = 50;

      function syncHighlightButton() {
        if (!highlightBtn) return;
        highlightBtn.textContent = highlightEnabled ? "Clear AIS Highlight" : "Highlight Sanctioned On AIS";
        highlightBtn.classList.toggle("btn-primary", highlightEnabled);
        highlightBtn.classList.toggle("btn-secondary", !highlightEnabled);
      }

      function normalizeText(value) {
        return String(value || "").toLowerCase().replace(/\s+/g, " ").trim();
      }

      function esc(value) {
        return String(value || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");
      }

      function parseCsvRow(line) {
        const out = [];
        let cur = "";
        let inQuotes = false;
        for (let i = 0; i < line.length; i++) {
          const ch = line[i];
          const next = line[i + 1];
          if (ch === '"') {
            if (inQuotes && next === '"') {
              cur += '"';
              i++;
              continue;
            }
            inQuotes = !inQuotes;
            continue;
          }
          if (ch === "," && !inQuotes) {
            out.push(cur);
            cur = "";
            continue;
          }
          cur += ch;
        }
        out.push(cur);
        return out.map((v) => String(v || "").trim());
      }

      function parseCsvText(text) {
        const lines = String(text || "").split(/\r?\n/).filter((x) => String(x || "").trim());
        if (!lines.length) return [];
        const headers = parseCsvRow(lines[0]).map((h) => normalizeText(h));
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
          const cols = parseCsvRow(lines[i]);
          if (!cols.length) continue;
          const obj = {};
          headers.forEach((h, idx) => {
            obj[h] = String(cols[idx] || "").trim();
          });
          rows.push(obj);
        }
        return rows;
      }

      function normalizeVesselRecord(raw) {
        const name = raw.caption || raw.name || "";
        const aliasesRaw = String(raw.aliases || "");
        const aliases = aliasesRaw
          ? aliasesRaw.split(/[|;,]/).map((x) => String(x || "").trim()).filter(Boolean)
          : [];
        const risk = String(raw.risk || "");
        const countries = String(raw.countries || "");
        const flag = String(raw.flag || "");
        const imo = String(raw.imo || "").replace(/^IMO/i, "").trim();
        const mmsi = String(raw.mmsi || "").trim();
        const datasets = String(raw.datasets || "");
        const url = String(raw.url || "");
        const id = String(raw.id || "");
        const searchBlob = [
          name, aliases.join(" "), risk, countries, flag, imo, mmsi, datasets, id
        ].join(" ");
        return {
          id,
          name: name || "Unknown Vessel",
          aliases,
          risk,
          countries,
          flag,
          imo,
          mmsi,
          datasets,
          url,
          _raw: raw,
          _search: normalizeText(searchBlob)
        };
      }

      async function loadDataset() {
        if (Array.isArray(dataset)) return dataset;
        if (loadingPromise) return loadingPromise;
        const path = "/data/watchlists/maritime.csv";
        loadingPromise = (async () => {
          try {
            const resp = await fetch(path, { headers: { Accept: "text/csv,text/plain,*/*" } });
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const text = await resp.text();
            dataset = parseCsvText(text).map(normalizeVesselRecord).filter((r) => r._search);
            if (metaEl) metaEl.textContent = `${dataset.length.toLocaleString()} records ready`;
            return dataset;
          } catch (_) {
            dataset = [];
            if (metaEl) metaEl.textContent = "Dataset unavailable";
            return dataset;
          }
        })();
        return loadingPromise;
      }

      async function loadLiveShips() {
        if (Array.isArray(liveShips) && liveShips.length) return liveShips;
        if (liveShipsPromise) return liveShipsPromise;
        liveShipsPromise = (async () => {
          try {
            const resp = await fetch("/data/live/ships_live.json", { headers: { Accept: "application/json" } });
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const rows = await resp.json();
            liveShips = Array.isArray(rows) ? rows : [];
            return liveShips;
          } catch (_) {
            liveShips = [];
            return liveShips;
          }
        })();
        return liveShipsPromise;
      }

      function normalizeShipNumber(value) {
        return String(value || "").replace(/^IMO/i, "").replace(/\D/g, "");
      }

      function liveShipMatchForVessel(row) {
        if (!Array.isArray(liveShips) || !liveShips.length) return null;
        const wantedMmsi = normalizeShipNumber(row?.mmsi);
        const wantedImo = normalizeShipNumber(row?.imo);
        const wantedName = normalizeText(row?.name);

        let hit = null;
        if (wantedMmsi) {
          hit = liveShips.find((s) => normalizeShipNumber(s?.mmsi) === wantedMmsi);
          if (hit) return hit;
        }
        if (wantedImo) {
          hit = liveShips.find((s) => normalizeShipNumber(s?.imo) === wantedImo);
          if (hit) return hit;
        }
        if (wantedName) {
          hit = liveShips.find((s) => normalizeText(s?.name || s?.shipName || "") === wantedName);
          if (hit) return hit;
        }
        return null;
      }

      function scoreMatch(row, qNorm, tokens) {
        if (!qNorm || !row?._search) return -1;
        if (row._search.includes(qNorm)) return 3;
        if (tokens.length && tokens.every(t => row._search.includes(t))) return 2;
        return -1;
      }

      function buildVesselI2EntityData(row) {
        const values = [];
        const push = (propertyName, value) => {
          const v = String(value || "").trim();
          if (!v) return;
          values.push({ propertyName, value: v });
        };
        push("Name", row.name);
        push("IMO", row.imo ? `IMO${row.imo}` : "");
        push("MMSI", row.mmsi);
        push("Type", "Sanctioned Vessel");
        push("Flag", row.flag);
        push("Country", row.countries);
        push("Risk", row.risk);
        push("Dataset", row.datasets);
        push("Source URL", row.url);
        push("UID", row.id);
        return {
          entityType: "Vessel",
          entityName: "Vessel",
          entityId: "ET24",
          values
        };
      }

      function londonLatLng() {
        return [51.5074, -0.1278];
      }

      function renderRows(rows, modeLabel = "") {
        if (!resultsEl) return;
        if (!rows.length) {
          resultsEl.innerHTML = '<div class="nr-empty">No sanctioned vessels found.</div>';
          return;
        }
        const labelHtml = modeLabel ? `<div class="mostwanted-status inline">${esc(modeLabel)}</div>` : "";
        resultsEl.innerHTML = labelHtml + rows.map(r => {
          const live = liveShipMatchForVessel(r);
          const liveLat = Number(live?.lat);
          const liveLon = Number(live?.lon);
          const liveOk = Number.isFinite(liveLat) && Number.isFinite(liveLon);
          const speed = Number.isFinite(Number(live?.speed)) ? Number(live.speed) : null;
          const heading = Number.isFinite(Number(live?.heading)) ? Number(live.heading) : null;
          return `<div class="ch-result-item" data-sv-id="${esc(r.id)}">
          <div class="ch-r-name" style="color:#38bdf8">${esc(r.name)}</div>
          ${liveOk ? `<div class="ch-r-detail"><span class="popup-label">Live AIS</span> Matched (${liveLat.toFixed(3)}, ${liveLon.toFixed(3)})</div>` : ""}
          ${liveOk && speed != null ? `<div class="ch-r-detail"><span class="popup-label">Live Speed</span> ${esc(speed)} kn</div>` : ""}
          ${liveOk && heading != null ? `<div class="ch-r-detail"><span class="popup-label">Live Heading</span> ${esc(heading)}°</div>` : ""}
          ${r.imo ? `<div class="ch-r-detail"><span class="popup-label">IMO</span> IMO${esc(r.imo)}</div>` : ""}
          ${r.mmsi ? `<div class="ch-r-detail"><span class="popup-label">MMSI</span> ${esc(r.mmsi)}</div>` : ""}
          ${r.flag ? `<div class="ch-r-detail"><span class="popup-label">Flag</span> ${esc(r.flag.toUpperCase())}</div>` : ""}
          ${r.countries ? `<div class="ch-r-detail"><span class="popup-label">Countries</span> ${esc(r.countries.toUpperCase())}</div>` : ""}
          ${r.risk ? `<div class="ch-r-detail"><span class="popup-label">Risk</span> ${esc(r.risk)}</div>` : ""}
          ${r.datasets ? `<div class="ch-r-detail"><span class="popup-label">Dataset</span> ${esc(r.datasets)}</div>` : ""}
          ${r.url ? `<div class="ch-r-detail"><a href="${esc(r.url)}" target="_blank" rel="noopener noreferrer">Source page</a></div>` : ""}
          <div class="cp-btn-row" style="margin-top:6px">
            <button type="button" class="btn-secondary btn-sm" data-sv-select="${esc(r.id)}">Select</button>
            <button type="button" class="btn-primary btn-sm" data-sv-add="${esc(r.id)}">Add Vessel</button>
            ${liveOk ? `<button type="button" class="btn-secondary btn-sm" data-sv-pan="${esc(r.id)}">Pan Live</button>` : ""}
          </div>
        </div>`;
        }).join("");
      }

      async function addVesselToStore(recordId) {
        const rows = await loadDataset();
        const row = rows.find(r => String(r.id) === String(recordId));
        if (!row) return;
        await loadLiveShips();
        const live = liveShipMatchForVessel(row);
        const liveLat = Number(live?.lat);
        const liveLon = Number(live?.lon);
        const hasLiveCoords = Number.isFinite(liveLat) && Number.isFinite(liveLon);
        if (!window.EntityStore || !window.EntityRenderer) {
          if (typeof window.showToast === "function") window.showToast("Entity store is unavailable", "error", 2500);
          return;
        }

        const existing = (window.EntityStore.getAll?.() || []).find((e) => {
          const attrs = e?.attributes || {};
          if (attrs.maritimeId && String(attrs.maritimeId) === String(row.id)) return true;
          if (row.imo && attrs.imo && String(attrs.imo).replace(/^IMO/i, "") === String(row.imo)) return true;
          if (row.mmsi && attrs.mmsi && String(attrs.mmsi) === String(row.mmsi)) return true;
          return false;
        });
        if (existing?.id) {
          if (window._map && Array.isArray(existing.latLng)) window._map.panTo(existing.latLng);
          if (typeof window.showToast === "function") window.showToast(`${row.name} already exists`, "info", 2200);
          return;
        }

        const attributes = {
          sourceType: "sanctioned_vessel",
          maritimeId: String(row.id || ""),
          name: row.name,
          imo: row.imo ? `IMO${row.imo}` : "",
          mmsi: row.mmsi || "",
          flag: row.flag || "",
          countries: row.countries || "",
          vesselType: "Sanctioned Vessel",
          risk: row.risk || "",
          aliases: row.aliases.join(", "),
          dataset: row.datasets || "",
          sourceUrl: row.url || "",
          uid: String(row.id || ""),
          notes: row.risk ? `Risk: ${row.risk}` : "",
          liveMatched: hasLiveCoords ? "yes" : "",
          liveMmsi: live?.mmsi ? String(live.mmsi) : "",
          liveSpeed: Number.isFinite(Number(live?.speed)) ? String(live.speed) : "",
          liveHeading: Number.isFinite(Number(live?.heading)) ? String(live.heading) : "",
          liveDestination: live?.destination ? String(live.destination) : ""
        };

        const entityId = window.EntityRenderer.placeEntityViaStore(
          "vessel",
          row.name,
          hasLiveCoords ? [liveLat, liveLon] : londonLatLng(),
          attributes,
          { method: hasLiveCoords ? "sanctioned_vessel_live_match" : "sanctioned_vessel_local", confidence: "medium" },
          buildVesselI2EntityData(row),
          null
        );

        if (entityId && typeof window.showToast === "function") {
          if (hasLiveCoords) {
            window.showToast(`Added live-matched vessel: ${row.name}`, "success", 2400);
          } else {
            window.showToast(`Added vessel: ${row.name}`, "success", 2200);
          }
        }
      }

      async function runSearch() {
        if (!resultsEl) return;
        const q = String(qInput?.value || "").trim();
        resultsEl.innerHTML = '<div class="mostwanted-status inline">Searching...</div>';
        const rows = await loadDataset();
        await loadLiveShips();
        if (!rows.length) {
          resultsEl.innerHTML = '<div class="nr-empty">Sanctioned vessels dataset unavailable.</div>';
          return;
        }

        if (!q) {
          if (rows.length <= SMALL_DATASET_MAX) {
            renderRows(rows, `Select from ${rows.length} records or type to filter.`);
          } else {
            resultsEl.innerHTML = '<div class="nr-empty">Enter a search term.</div>';
          }
          return;
        }

        const qNorm = normalizeText(q);
        const tokens = qNorm.split(/[^a-z0-9]+/).filter(Boolean);
        const matched = rows
          .map(row => ({ row, score: scoreMatch(row, qNorm, tokens) }))
          .filter(x => x.score >= 0)
          .sort((a, b) => (b.score - a.score) || a.row.name.localeCompare(b.row.name))
          .slice(0, 80)
          .map(x => x.row);

        renderRows(matched, `Showing ${matched.length} result(s).`);
      }

      searchBtn?.addEventListener("click", runSearch);
      clearBtn?.addEventListener("click", () => {
        if (qInput) qInput.value = "";
        runSearch();
      });
      highlightBtn?.addEventListener("click", async () => {
        highlightEnabled = !highlightEnabled;
        syncHighlightButton();
        try {
          await window.ensureShipsLoaded?.();
          await window.setAisSanctionHighlight?.(highlightEnabled);
          if (typeof window.showToast === "function") {
            window.showToast(
              highlightEnabled ? "Sanctioned vessels highlighted on AIS" : "AIS sanction highlight cleared",
              "info",
              2000
            );
          }
        } catch (_) {
          if (typeof window.showToast === "function") window.showToast("Could not update AIS highlight", "error", 2200);
        }
      });
      qInput?.addEventListener("keydown", (ev) => {
        if (ev.key !== "Enter") return;
        ev.preventDefault();
        runSearch();
      });
      qInput?.addEventListener("input", () => {
        if (inputTimer) clearTimeout(inputTimer);
        inputTimer = setTimeout(runSearch, 140);
      });
      qInput?.addEventListener("focus", () => {
        if (!dataset && !loadingPromise) {
          loadDataset().then(() => runSearch());
          return;
        }
        if (!String(qInput?.value || "").trim()) runSearch();
      });
      resultsEl?.addEventListener("click", async (ev) => {
        const t = ev.target;
        if (!(t instanceof HTMLElement)) return;
        const pickId = t.getAttribute("data-sv-select");
        const addId = t.getAttribute("data-sv-add");
        const panId = t.getAttribute("data-sv-pan");
        const id = pickId || addId || panId;
        if (!id) return;
        const rows = await loadDataset();
        const row = rows.find(r => String(r.id) === String(id));
        if (!row) return;
        if (pickId) {
          if (qInput) qInput.value = row.name;
          runSearch();
          return;
        }
        if (addId) {
          await addVesselToStore(id);
          return;
        }
        if (panId) {
          await loadLiveShips();
          const live = liveShipMatchForVessel(row);
          const lat = Number(live?.lat);
          const lon = Number(live?.lon);
          if (window._map && Number.isFinite(lat) && Number.isFinite(lon)) {
            window._map.panTo([lat, lon]);
            if (typeof window.showToast === "function") window.showToast(`Panned to live vessel position`, "info", 1800);
          }
        }
      });
      syncHighlightButton();
    })();

    // ── Live Clock, Coords & Zoom in KPI bar ──
    (function initKpiLiveInfo() {
      function updateClock() {
        const now = new Date();
        const el = document.getElementById("kpi-clock");
        if (el) el.textContent = now.toLocaleTimeString("en-GB", { hour12: false });
      }
      updateClock();
      setInterval(updateClock, 1000);

      // Update coords + zoom on map move
      function updateMapInfo() {
        if (!window._map) return;
        const c = window._map.getCenter();
        const z = window._map.getZoom();
        const coordsEl = document.getElementById("kpi-coords");
        const zoomEl = document.getElementById("kpi-zoom");
        if (coordsEl) coordsEl.textContent = c.lat.toFixed(4) + ", " + c.lng.toFixed(4);
        if (zoomEl) zoomEl.textContent = "Z" + z;
      }
      // Poll until map is ready, then bind
      const mapCheck = setInterval(() => {
        if (window._map) {
          clearInterval(mapCheck);
          window._map.on("moveend zoomend", updateMapInfo);
          updateMapInfo();
        }
      }, 500);

      // Update session time in status bar
      const sessionStart = Date.now();
      setInterval(() => {
        const elapsed = Date.now() - sessionStart;
        const mins = Math.floor(elapsed / 60000);
        const hrs = Math.floor(mins / 60);
        const dispMins = mins % 60;
        const el = document.getElementById("status-session");
        if (el) el.textContent = "Session: " + (hrs > 0 ? hrs + "h " + dispMins + "m" : dispMins + "m");
      }, 10000);
    })();
  </script>

</body>
</html>
