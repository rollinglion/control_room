<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Control Room</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

  <div id="control-panel">
    <div class="cp-header">
      <span class="cp-title">CONTROL ROOM</span>
      <button id="cp-toggle" title="Collapse panel">&minus;</button>
    </div>

    <div class="cp-body" id="cp-body">
      <!-- Tabs -->
      <div class="cp-tabs">
        <button class="cp-tab active" data-tab="search" title="Search and plot companies on map">Companies</button>
        <button class="cp-tab" data-tab="people" title="Search for people and PSC data">People</button>
        <button class="cp-tab" data-tab="entities" title="Add custom entities to map">Entities / i2</button>
        <button class="cp-tab" data-tab="layers" title="Toggle map layers and base map">Layers</button>
      </div>

      <!-- â•â•â• Company Search Tab â•â•â• -->
      <div class="cp-tab-pane active" id="tab-search">
        <div id="data-progress" class="cp-progress done">
          <div class="cp-progress-label">
            <span id="progress-text">Searching...</span>
            <span id="progress-pct">0 %</span>
          </div>
          <div class="cp-progress-track">
            <div class="cp-progress-fill" id="progress-fill"></div>
          </div>
        </div>

        <label for="ch_name">Company Name</label>
        <input id="ch_name" type="text" placeholder="e.g. Bristol City" />

        <label for="ch_number">Company Number</label>
        <input id="ch_number" type="text" placeholder="e.g. 03230871" />

        <details class="panel-disclosure">
          <summary>Advanced Company Filters</summary>
          <label for="ch_postcode">Postcode (filter)</label>
          <input id="ch_postcode" type="text" placeholder="e.g. BS3 2EJ" />

          <label for="ch_town">Post Town (filter)</label>
          <input id="ch_town" type="text" placeholder="e.g. Bristol" />

          <label for="ch_status">Company Status</label>
          <select id="ch_status">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="dissolved">Dissolved</option>
            <option value="liquidation">In Liquidation</option>
            <option value="administration">In Administration</option>
          </select>

          <label for="ch_sic">SIC Code (filter)</label>
          <select id="ch_sic">
            <option value="">All SIC Codes</option>
            <option value="93120">93120 - Activities of sport clubs</option>
            <option value="93110">93110 - Operation of sports facilities</option>
            <option value="64191">64191 - Banks</option>
            <option value="64192">64192 - Building societies</option>
            <option value="64209">64209 - Other financial service activities</option>
            <option value="64303">64303 - Activities of investment trusts</option>
            <option value="68100">68100 - Buying and selling of own real estate</option>
            <option value="68209">68209 - Other letting and operating of own/leased real estate</option>
            <option value="70100">70100 - Activities of head offices</option>
            <option value="64110">64110 - Central banking</option>
            <option value="86101">86101 - Hospital activities</option>
            <option value="86210">86210 - General medical practice activities</option>
            <option value="47110">47110 - Retail sale in non-specialised stores</option>
            <option value="56101">56101 - Licensed restaurants</option>
            <option value="56103">56103 - Take-away food shops and mobile food stands</option>
            <option value="56210">56210 - Event catering activities</option>
            <option value="62012">62012 - Business and domestic software development</option>
            <option value="62020">62020 - Information technology consultancy activities</option>
            <option value="41100">41100 - Development of building projects</option>
            <option value="41201">41201 - Construction of commercial buildings</option>
          </select>
        </details>

        <div class="cp-btn-row">
          <button id="ch_search" class="btn-primary">Search API</button>
          <button id="ch_clear" class="btn-secondary">Clear</button>
        </div>

        <div id="ch_results"></div>

        <!-- â•â•â• QUICK SEARCH (AUTOCOMPLETE) â•â•â• -->
        <div class="api-search-divider">
          <span>-- OR QUICK SEARCH --</span>
        </div>

        <label for="ch_api_search">Type-ahead Search</label>
        <div class="autocomplete-wrapper">
          <input id="ch_api_search" type="text" placeholder="Start typing company name..." />
          <div id="ch_api_suggestions" class="suggestions-dropdown"></div>
        </div>

        <div id="ch_api_selected"></div>
        <!-- â•â•â• END QUICK SEARCH â•â•â• -->

      </div>

      <!-- â•â•â• People (PSC) Tab â•â•â• -->
      <div class="cp-tab-pane" id="tab-people">
        <div id="psc-progress" class="cp-progress done">
          <div class="cp-progress-label">
            <span id="psc-progress-text">Searching...</span>
            <span id="psc-progress-pct"></span>
          </div>
          <div class="cp-progress-track">
            <div class="cp-progress-fill" id="psc-progress-fill"></div>
          </div>
        </div>

        <label for="psc_name">Person / Officer Name</label>
        <input id="psc_name" type="text" placeholder="e.g. John Smith" title="Search for officers by name (min 3 characters)" />

        <label for="psc_company">Company Number (for PSC)</label>
        <input id="psc_company" type="text" placeholder="e.g. 08209948" title="View PSC data for a specific company" />

        <div class="cp-btn-row">
          <button id="psc_search" class="btn-primary" title="Search for PSC or officers via API">Search API</button>
          <button id="psc_clear" class="btn-secondary">Clear</button>
        </div>

        <div class="psc-help-text">
          Enter a person's name to search for officer appointments, or a company number to view PSC records with PDF download.
        </div>

        <div id="psc_results"></div>
      </div>

      <!-- â•â•â• Entities Tab â•â•â• -->
      <div class="cp-tab-pane" id="tab-entities">
        <div class="entity-help">
          <strong>Entity Placement + i2 Workspace</strong>
          <p><strong>To place:</strong> Click a category below -> click on map -> enter details (name, address, notes)</p>
          <p><strong>To connect:</strong> Click Connect on any entity -> click target entity -> enter label</p>
          <p>Icons auto-suggest based on i2 fields and entity content (including military SIDC/JMSML symbols).</p>
        </div>

        <div class="entity-import-panel">
          <div class="entity-import-title">Bulk Import (i2-style)</div>
          <input id="entity-import-file" type="file" accept=".xlsx,.xls,.csv,.tsv,.txt" />
          <div class="cp-btn-row">
            <button id="entity-import-run" class="btn-primary">Import And Plot</button>
            <button id="entity-import-clear" class="btn-secondary">Clear Imported</button>
          </div>
          <div id="entity-import-summary" class="entity-import-summary">
            Upload Excel/CSV. The importer auto-detects names, DOB, addresses, postcodes, coordinates and relationship columns.
          </div>
        </div>
        
        <div id="entity_selector" class="entity-grid">
          <!-- Populated by JavaScript -->
        </div>
        
        <div class="entity-stats">
          <div class="entity-stat-item">
            <span class="entity-stat-label">Entities on map:</span>
            <span id="entity_count" class="entity-stat-value">0</span>
          </div>
          <div class="entity-stat-item">
            <span class="entity-stat-label">Connections:</span>
            <span id="connection_count" class="entity-stat-value">0</span>
          </div>
        </div>

        <details class="panel-disclosure" id="entities-i2-workspace">
          <summary>i2 Planning Workspace</summary>
          <div class="i2-stats-grid">
            <div class="i2-stat-card">
              <span class="i2-stat-label">Import Templates</span>
              <span id="i2-template-count" class="i2-stat-value">--</span>
            </div>
            <div class="i2-stat-card">
              <span class="i2-stat-label">Entity Types</span>
              <span id="i2-entity-count" class="i2-stat-value">--</span>
            </div>
            <div class="i2-stat-card">
              <span class="i2-stat-label">Link Types</span>
              <span id="i2-link-count" class="i2-stat-value">--</span>
            </div>
            <div class="i2-stat-card">
              <span class="i2-stat-label">Match Rules</span>
              <span id="i2-rule-count" class="i2-stat-value">--</span>
            </div>
          </div>

          <label for="i2-template-select">Import Template</label>
          <select id="i2-template-select">
            <option value="">Loading templates...</option>
          </select>
          <div id="i2-template-details" class="i2-panel-block">Select a template to inspect mappings.</div>

          <label for="i2-entity-search">Entity Type Search</label>
          <input id="i2-entity-search" type="text" placeholder="e.g. Communication Entity, Aircraft, Person" />
          <div id="i2-entity-results" class="i2-panel-block">Loading catalog...</div>
        </details>
      </div>

      <!-- â•â•â• Layers Tab â•â•â• -->
      <div class="cp-tab-pane" id="tab-layers">

        <div class="layer-section-title">Base Map</div>
        <div class="base-pills" id="base-pills">
          <button class="bl-pill active" data-base="Dark">Dark</button>
          <button class="bl-pill" data-base="Grey">Grey</button>
          <button class="bl-pill" data-base="Street">Street</button>
          <button class="bl-pill" data-base="Satellite">Satellite</button>
        </div>

        <div class="layer-section-title">Data Overlays</div>

        <label class="layer-row">
          <input type="checkbox" class="layer-cb" data-layer="areas">
          <span class="toggle-track"><span class="toggle-thumb"></span></span>
          <span class="layer-dot" style="background:#818cf8"></span>
          <span class="layer-name">Police Force Areas</span>
        </label>

        <label class="layer-row">
          <input type="checkbox" class="layer-cb" data-layer="airports_uk">
          <span class="toggle-track"><span class="toggle-thumb"></span></span>
          <span class="layer-dot" style="background:#38bdf8"></span>
          <span class="layer-name">UK Airports</span>
        </label>

        <label class="layer-row">
          <input type="checkbox" class="layer-cb" data-layer="airports_global">
          <span class="toggle-track"><span class="toggle-thumb"></span></span>
          <span class="layer-dot" style="background:#0284c7"></span>
          <span class="layer-name">Global Airports</span>
        </label>

        <label class="layer-row">
          <input type="checkbox" class="layer-cb" data-layer="seaports">
          <span class="toggle-track"><span class="toggle-thumb"></span></span>
          <span class="layer-dot" style="background:#2dd4bf"></span>
          <span class="layer-name">Seaports</span>
        </label>

        <label class="layer-row">
          <input type="checkbox" class="layer-cb" data-layer="underground">
          <span class="toggle-track"><span class="toggle-thumb"></span></span>
          <span class="layer-dot" style="background:#f43f5e"></span>
          <span class="layer-name">TfL Stations (Underground, DLR, Tram, Rail)</span>
        </label>

        <label class="layer-row">
          <input type="checkbox" class="layer-cb" data-layer="companies" checked>
          <span class="toggle-track"><span class="toggle-thumb"></span></span>
          <span class="layer-dot" style="background:#a78bfa"></span>
          <span class="layer-name">Companies (search)</span>
        </label>

        <div class="layer-section-title">Live Data</div>

        <label class="layer-row">
          <input type="checkbox" class="layer-cb" data-layer="flights">
          <span class="toggle-track"><span class="toggle-thumb"></span></span>
          <span class="layer-dot" style="background:#f59e0b"></span>
          <span class="layer-name">Live Flights (OpenSky)</span>
        </label>

        <details class="panel-disclosure layer-tool-block" data-layer-tools="flights">
          <summary>Flight Intelligence Filters</summary>
          <div class="flight-intel-tools">
            <label for="flight-airport-q">Airport (IATA/ICAO/Name/City)</label>
            <input id="flight-airport-q" type="text" placeholder="e.g. LHR, EGLL, Heathrow, London" />

            <label for="flight-origin-q">Origin Airport</label>
            <input id="flight-origin-q" type="text" placeholder="IATA/ICAO/Name/City" />

            <label for="flight-destination-q">Destination Airport</label>
            <input id="flight-destination-q" type="text" placeholder="IATA/ICAO/Name/City" />

            <label for="flight-aircraft-q">Aircraft (ICAO24)</label>
            <input id="flight-aircraft-q" type="text" placeholder="e.g. 40621a" />

            <label for="flight-number-q">Flight Number / Callsign</label>
            <input id="flight-number-q" type="text" placeholder="e.g. BAW130" />

            <div class="flight-intel-time-row">
              <div>
                <label for="flight-time-from">Seen From</label>
                <input id="flight-time-from" type="time" />
              </div>
              <div>
                <label for="flight-time-to">Seen To</label>
                <input id="flight-time-to" type="time" />
              </div>
            </div>

            <div class="flight-intel-actions">
              <button id="flight-filter-btn" class="btn-secondary btn-sm" type="button">Apply Flight Filter</button>
              <button id="flight-filter-clear-btn" class="btn-secondary btn-sm" type="button">Clear Filter</button>
            </div>
            <div id="flight-filter-results" class="flight-filter-results"></div>
          </div>
        </details>

        <label class="layer-row">
          <input type="checkbox" class="layer-cb" data-layer="bikes">
          <span class="toggle-track"><span class="toggle-thumb"></span></span>
          <span class="layer-dot" style="background:#22c55e"></span>
          <span class="layer-name">Santander Cycles</span>
        </label>

        <label class="layer-row">
          <input type="checkbox" class="layer-cb" data-layer="national_rail">
          <span class="toggle-track"><span class="toggle-thumb"></span></span>
          <span class="layer-dot" style="background:#38bdf8"></span>
          <span class="layer-name">National Rail (Live Boards)</span>
        </label>

        <label class="layer-row">
          <input type="checkbox" class="layer-cb" data-layer="roads">
          <span class="toggle-track"><span class="toggle-thumb"></span></span>
          <span class="layer-dot" style="background:#f97316"></span>
          <span class="layer-name">Road Traffic (WebTRIS)</span>
        </label>

        <details class="panel-disclosure layer-tool-block" data-layer-tools="underground">
          <summary>
            TfL Line Status
            <span id="tfl-status-time" class="tfl-status-time">--:--</span>
          </summary>
          <div id="tfl-selected-line" class="tfl-selected-line">Selected: None</div>
          <div id="tfl-status-grid"></div>
        </details>

        <details class="panel-disclosure layer-tool-block" data-layer-tools="underground">
          <summary>TfL StopPoint Ops</summary>
          <div class="tfl-stop-tools">
            <label for="tfl-stop-query">Search Stops / Stations</label>
            <div class="tfl-stop-row">
              <input id="tfl-stop-query" type="text" placeholder="e.g. Baker Street or 490008660N" />
              <button id="tfl-stop-search-btn" class="btn-secondary btn-sm" type="button">Search</button>
            </div>

            <label for="tfl-stop-mode">Mode Filter</label>
            <select id="tfl-stop-mode">
              <option value="">All modes</option>
              <option value="tube">Tube</option>
              <option value="overground">Overground</option>
              <option value="elizabeth-line">Elizabeth line</option>
              <option value="dlr">DLR</option>
              <option value="tram">Tram</option>
              <option value="bus">Bus</option>
              <option value="national-rail">National Rail</option>
            </select>

            <div class="tfl-stop-row">
              <button id="tfl-stop-nearby-btn" class="btn-secondary btn-sm" type="button">Nearby (Map Center)</button>
              <button id="tfl-stop-clear-btn" class="btn-secondary btn-sm" type="button">Clear</button>
            </div>
          <div id="tfl-stop-results" class="tfl-stop-results"></div>
          </div>
        </details>

        <details class="panel-disclosure layer-tool-block" data-layer-tools="national_rail">
          <summary>National Rail Ops</summary>
          <div class="nr-tools">
            <label for="nr-crs-input">CRS Station Code</label>
          <div class="nr-row">
            <input id="nr-crs-input" type="text" list="nr-crs-list" placeholder="Type station or CRS (e.g. KGX, Kings Cross)" />
            <button id="nr-fetch-btn" class="btn-secondary btn-sm" type="button">Fetch</button>
          </div>
          <datalist id="nr-crs-list"></datalist>

            <label for="nr-board-type">Board Type</label>
            <select id="nr-board-type">
              <option value="departures">Departures</option>
              <option value="arrivals">Arrivals</option>
            </select>

            <div class="nr-row">
              <button id="nr-refresh-btn" class="btn-secondary btn-sm" type="button">Refresh</button>
              <button id="nr-clear-btn" class="btn-secondary btn-sm" type="button">Clear</button>
            </div>
            <div id="nr-results" class="nr-results"></div>
          </div>
        </details>

        <details class="panel-disclosure layer-tool-block" data-layer-tools="roads">
          <summary>Road Traffic Ops (WebTRIS)</summary>
          <div class="roads-tools">
            <label for="roads-site-query">Site Search (ID / Name / Road)</label>
            <div class="roads-row">
              <input id="roads-site-query" type="text" placeholder="e.g. M25, A1M, site id 2" />
              <button id="roads-site-search-btn" class="btn-secondary btn-sm" type="button">Search</button>
            </div>

            <label for="roads-date">Report Date</label>
            <input id="roads-date" type="date" />

            <div class="roads-row">
              <button id="roads-refresh-btn" class="btn-secondary btn-sm" type="button">Refresh</button>
              <button id="roads-clear-btn" class="btn-secondary btn-sm" type="button">Clear</button>
            </div>
            <div id="roads-results" class="roads-results"></div>
          </div>
        </details>

        <details class="panel-disclosure" id="system-health-panel" open>
          <summary>System Health</summary>
          <div id="system-health-results" class="system-health-results">
            <div class="nr-empty">Checking hosted services...</div>
          </div>
        </details>

      </div>

    </div>
  </div>

  <!-- Status bar -->
  <div id="status-bar">
    <span id="status-text">Initialising...</span>
  </div>

  <!-- Entity Placement Panel -->
  <div id="entity-placement-panel" class="entity-panel">
    <div class="entity-panel-header">
      <span class="entity-panel-title">PLACE ENTITY</span>
      <button id="entity-panel-close" class="entity-panel-close-btn">&times;</button>
    </div>
    <div class="entity-panel-body">
      <form id="entity-placement-form">
        <label for="entity-label">Display Label <span style="opacity: 0.5; font-weight: 400;">(optional override)</span></label>
        <input type="text" id="entity-label" placeholder="Leave blank to derive from i2 fields" />
        
        <label for="entity-category">Category</label>
        <select id="entity-category" required>
          <option value="">Select category...</option>
        </select>
        
        <label for="entity-icon">Icon</label>
        <select id="entity-icon" required>
          <option value="">Select icon...</option>
        </select>

        <label for="entity-mil-symbol">Military Symbol (SIDC/JMSML, optional)</label>
        <input id="entity-mil-symbol" type="text" list="entity-mil-symbol-list" placeholder="e.g. 01110104 or Fighter" />
        <datalist id="entity-mil-symbol-list"></datalist>

        <label for="entity-i2-type">i2 Entity Type</label>
        <select id="entity-i2-type">
          <option value="">Loading i2 entity types...</option>
        </select>

        <div class="cp-btn-row entity-panel-actions-top">
          <button type="submit" class="btn-primary">PLACE ENTITY</button>
          <button type="button" class="btn-secondary" id="entity-cancel-btn">CANCEL</button>
        </div>

        <div id="entity-i2-fields" class="entity-i2-fields">
          <div class="entity-i2-fields-empty">Loading i2 properties...</div>
        </div>

        <label for="entity-placement-address">Placement Address / Postcode <span style="opacity: 0.5; font-weight: 400;">(optional)</span></label>
        <input type="text" id="entity-placement-address" placeholder="e.g. 1 Osmond Drive, Wells, BA5 2JX" />
        <div class="entity-i2-meta">Used for map geocoding when postcode/address is not present in i2 fields.</div>
        
        <div class="entity-panel-coords">
          <span class="popup-label">Coordinates</span>
          <span id="entity-coords">--</span>
        </div>
        
      </form>
    </div>
  </div>

  <!-- Flight Info Panel -->
  <div id="flight-info" class="flight-info-panel" style="display:none;">
    <div class="flight-info-header">
      <span>LIVE FLIGHTS</span>
      <span id="flight-info-time" class="flight-info-time">--:--</span>
      <button id="flight-refresh-btn" class="flight-refresh-btn" title="Refresh now">&#x21bb;</button>
    </div>
    <div id="flight-stats" class="flight-stats"></div>
  </div>

  <div id="map"></div>
  <button id="mobile-panel-toggle" class="mobile-panel-toggle" type="button" title="Toggle control panel">Panel</button>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- API Keys (gitignored â€” copy api_keys.example.js to api_keys.js) -->
  <script src="js/api_keys.js"></script>

  <!-- Core Config -->
  <script src="js/config.js"></script>
  <script src="js/api_base.js"></script>

  <!-- API Modules -->
  <script src="js/ch_api.js"></script>
  <script src="js/psc_api.js"></script>

  <!-- Icons -->
  <script src="js/icons.js"></script>

  <!-- Map -->
  <script src="js/map.js"></script>

  <!-- Live Data Layers -->
  <script src="js/tfl_live.js"></script>
  <script src="js/national_rail.js"></script>
  <script src="js/roads_live.js"></script>
  <script src="js/opensky.js"></script>
  <script src="js/system_health.js"></script>
  <script src="js/i2_workspace.js"></script>

</body>
</html>
