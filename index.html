<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Control Room</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <script>
    (function blockFileProtocolMode() {
      if (window.location.protocol !== "file:") return;
      const localBase = "http://localhost:8000";
      const localUrl = localBase + "/index.html" + window.location.search + window.location.hash;
      document.open();
      document.write(
        "<!doctype html><html lang='en'><head><meta charset='utf-8'><title>Control Room - Start Local Server</title>" +
        "<meta name='viewport' content='width=device-width, initial-scale=1'>" +
        "<style>" +
        "body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:#0f172a;color:#e2e8f0;display:grid;place-items:center;min-height:100vh;padding:20px;}" +
        ".card{max-width:760px;background:#111827;border:1px solid #334155;border-radius:14px;padding:22px;box-shadow:0 20px 50px rgba(0,0,0,.35);}" +
        "h1{margin:0 0 10px;font-size:22px;}p{line-height:1.45;margin:8px 0 0;}" +
        "code{background:#0b1220;border:1px solid #334155;border-radius:6px;padding:2px 6px;}" +
        ".cmd{margin-top:12px;background:#0b1220;border:1px solid #334155;border-radius:8px;padding:10px 12px;font-family:Consolas,monospace;}" +
        ".row{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px;}" +
        "a{display:inline-block;text-decoration:none;background:#2563eb;color:#fff;padding:10px 14px;border-radius:8px;font-weight:600;}" +
        ".pill{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid #334155;background:#0b1220;font-size:12px;}" +
        ".muted{opacity:.85;font-size:14px;margin-top:10px;}" +
        "</style></head><body><main class='card'>" +
        "<h1>Run Control Room over HTTP</h1>" +
        "<p>This app cannot load local JSON/GeoJSON when opened as <code>file://</code>. Browser CORS blocks all overlays (rail, roads, airports, service stations).</p>" +
        "<p>Start the included server from this project folder:</p>" +
        "<div class='cmd'>python scripts/dev_server.py</div>" +
        "<div class='row'><a href='" + localUrl + "'>Open http://localhost:8000</a><span id='cr-server-status' class='pill'>Checking localhost...</span></div>" +
        "<p class='muted'>This page auto-redirects when the local server responds.</p>" +
        "<script>(function(){var health='"+ localBase + "/__control_room_health';var target='"+ localUrl + "';var badge=document.getElementById('cr-server-status');function setLabel(t){if(badge)badge.textContent=t;}function ping(){fetch(health,{cache:'no-store'}).then(function(r){if(r.ok){setLabel('Server online. Redirecting...');window.location.replace(target);}else{setLabel('Server not reachable');setTimeout(ping,1200);}}).catch(function(){setLabel('Server not reachable');setTimeout(ping,1200);});}ping();})();<\/script>" +
        "</main></body></html>"
      );
      document.close();
      throw new Error("Control Room must run over http://localhost:8000, not file://");
    })();

  </script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
  <link rel="stylesheet" href="css/style.css">
  <!-- vis-network for link analysis graph -->
  <script src="https://unpkg.com/vis-network@9.1.6/standalone/umd/vis-network.min.js"></script>
</head>
<body>
  <!-- ═══ KPI DASHBOARD STRIP ═══ -->
  <div id="kpi-bar" class="kpi-bar">
    <div class="kpi-brand">
      <span class="kpi-brand-title">CONTROL ROOM</span>
      <span class="kpi-brand-sub">Intelligence Dashboard</span>
    </div>
    <div class="kpi-separator"></div>
    <div class="kpi-grid">
      <div class="kpi-card" title="Map entities placed">
        <span class="kpi-value" id="kpi-entities">0</span>
        <span class="kpi-label">Entities</span>
      </div>
      <div class="kpi-card" title="Entity connections">
        <span class="kpi-value" id="kpi-connections">0</span>
        <span class="kpi-label">Links</span>
      </div>
      <div class="kpi-card" title="Active overlay layers">
        <span class="kpi-value" id="kpi-layers">0</span>
        <span class="kpi-label">Layers</span>
      </div>
      <div class="kpi-card" title="Searches performed">
        <span class="kpi-value" id="kpi-searches">0</span>
        <span class="kpi-label">Searches</span>
      </div>
      <div class="kpi-card kpi-card-alert" title="Alert events">
        <span class="kpi-value" id="kpi-alerts">0</span>
        <span class="kpi-label">Alerts</span>
      </div>
      <div class="kpi-card kpi-card-ops" title="Operational complexity score">
        <span class="kpi-value" id="kpi-ops-score">0</span>
        <span class="kpi-label">OPS</span>
      </div>
    </div>
    <div class="kpi-separator"></div>
    <div class="kpi-live-info">
      <span class="kpi-clock" id="kpi-clock">--:--:--</span>
      <span class="kpi-coords" id="kpi-coords" title="Map centre coordinates">--</span>
      <span class="kpi-zoom" id="kpi-zoom" title="Zoom level">Z--</span>
    </div>
    <div class="kpi-separator"></div>
    <div class="kpi-actions">
      <button class="kpi-action-btn" id="kpi-btn-save" title="Save workspace (Ctrl+S)">Save</button>
      <button class="kpi-action-btn kpi-action-intel" id="kpi-btn-report" title="3x5x2 Intelligence Report (Ctrl+Shift+R)">3x5x2</button>
      <button class="kpi-action-btn" id="kpi-btn-anx" title="Export i2 ANX (Ctrl+Shift+X)">i2 ANX</button>
      <button class="kpi-action-btn" id="kpi-btn-excel" title="Export structured Excel">Excel</button>
      <button class="kpi-action-btn kpi-action-help" id="kpi-btn-help" title="Keyboard shortcuts (F1)">F1</button>
    </div>
  </div>

  <div id="control-panel">
    <div class="cp-header">
      <span class="cp-title">OPERATIONS</span>
      <div class="cp-header-actions">
        <button id="cp-menu-btn" class="cp-menu-btn" type="button" title="Open panel menu">Menu</button>
        <div id="cp-menu" class="cp-menu hidden" role="menu" aria-hidden="true">
          <button class="cp-menu-item" type="button" data-tab-target="search" role="menuitem">Search</button>
          <button class="cp-menu-item" type="button" data-tab-target="entities" role="menuitem">Entities</button>
          <button class="cp-menu-item" type="button" data-tab-target="layers" role="menuitem">Layers</button>
        </div>
        <button id="cp-toggle" title="Collapse panel">&minus;</button>
      </div>
    </div>
    <div class="cp-meta-strip">
      <span class="cp-meta-chip"><strong id="cp-active-layers">0</strong> Layers</span>
      <span class="cp-meta-chip"><strong id="cp-entities-chip">0</strong> Entities</span>
      <span class="cp-meta-chip"><strong id="cp-links-chip">0</strong> Links</span>
      <span class="cp-meta-chip cp-meta-chip-score"><strong id="cp-ops-score">0</strong> OPS <em id="cp-ops-rank">Observer</em></span>
    </div>

    <div class="cp-body" id="cp-body">
      <!-- Tabs -->
      <div class="cp-tabs" role="tablist" aria-label="Control panel sections">
        <button id="cp-tab-btn-search" class="cp-tab active" data-tab="search" title="Search companies and people" role="tab" aria-controls="tab-search" aria-selected="true" tabindex="0">Search</button>
        <button id="cp-tab-btn-entities" class="cp-tab" data-tab="entities" title="Add custom entities to map" role="tab" aria-controls="tab-entities" aria-selected="false" tabindex="-1">Entities</button>
        <button id="cp-tab-btn-layers" class="cp-tab" data-tab="layers" title="Toggle map layers and base map" role="tab" aria-controls="tab-layers" aria-selected="false" tabindex="-1">Layers</button>
      </div>

      <!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â Company Search Tab Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
      <div class="cp-tab-pane active" id="tab-search" role="tabpanel" aria-labelledby="cp-tab-btn-search" aria-hidden="false">
        <div id="data-progress" class="cp-progress done">
          <div class="cp-progress-label">
            <span id="progress-text">Searching...</span>
            <span id="progress-pct">0 %</span>
          </div>
          <div class="cp-progress-track">
            <div class="cp-progress-fill" id="progress-fill"></div>
          </div>
        </div>

        <div class="cp-quick-actions" aria-label="Search quick actions">
          <button id="quick-search-company" class="quick-action-btn" type="button">Company Search</button>
          <button id="quick-search-officer" class="quick-action-btn" type="button">Officer / PSC</button>
          <button id="quick-search-dvla" class="quick-action-btn" type="button">Vehicle Lookup</button>
        </div>
        <div class="cp-quick-hint">Tip: Use quick actions to jump to the right tool without scrolling.</div>

        <label for="ch_name">Company Name</label>
        <input id="ch_name" type="text" placeholder="e.g. Bristol City" />

        <label for="ch_number">Company Number</label>
        <input id="ch_number" type="text" placeholder="e.g. 03230871" />

        <details class="panel-disclosure">
          <summary>Advanced Company Filters</summary>
          <label for="ch_postcode">Postcode (filter)</label>
          <input id="ch_postcode" type="text" placeholder="e.g. BS3 2EJ" />

          <label for="ch_town">Post Town (filter)</label>
          <input id="ch_town" type="text" placeholder="e.g. Bristol" />

          <label for="ch_status">Company Status</label>
          <select id="ch_status">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="dissolved">Dissolved</option>
            <option value="liquidation">In Liquidation</option>
            <option value="administration">In Administration</option>
          </select>

          <label for="ch_sic">SIC Code (filter)</label>
          <select id="ch_sic">
            <option value="">All SIC Codes</option>
            <option value="93120">93120 - Activities of sport clubs</option>
            <option value="93110">93110 - Operation of sports facilities</option>
            <option value="64191">64191 - Banks</option>
            <option value="64192">64192 - Building societies</option>
            <option value="64209">64209 - Other financial service activities</option>
            <option value="64303">64303 - Activities of investment trusts</option>
            <option value="68100">68100 - Buying and selling of own real estate</option>
            <option value="68209">68209 - Other letting and operating of own/leased real estate</option>
            <option value="70100">70100 - Activities of head offices</option>
            <option value="64110">64110 - Central banking</option>
            <option value="86101">86101 - Hospital activities</option>
            <option value="86210">86210 - General medical practice activities</option>
            <option value="47110">47110 - Retail sale in non-specialised stores</option>
            <option value="56101">56101 - Licensed restaurants</option>
            <option value="56103">56103 - Take-away food shops and mobile food stands</option>
            <option value="56210">56210 - Event catering activities</option>
            <option value="62012">62012 - Business and domestic software development</option>
            <option value="62020">62020 - Information technology consultancy activities</option>
            <option value="41100">41100 - Development of building projects</option>
            <option value="41201">41201 - Construction of commercial buildings</option>
          </select>
        </details>

        <div class="cp-btn-row">
          <button id="ch_search" class="btn-primary">Search API</button>
          <button id="ch_clear" class="btn-secondary">Clear</button>
        </div>

        <div id="ch-results-skeleton" class="cp-skeleton-list hidden" aria-hidden="true">
          <div class="cp-skeleton-row"></div>
          <div class="cp-skeleton-row"></div>
          <div class="cp-skeleton-row"></div>
        </div>
        <div id="ch_results"></div>

        <!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â QUICK SEARCH (AUTOCOMPLETE) Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
        <div class="api-search-divider">
          <span>-- OR QUICK SEARCH --</span>
        </div>

        <label for="ch_api_search">Type-ahead Search</label>
        <div class="autocomplete-wrapper">
          <input id="ch_api_search" type="text" placeholder="Start typing company name..." />
          <div id="ch_api_suggestions" class="suggestions-dropdown"></div>
        </div>

        <div id="ch_api_selected"></div>
        <!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â END QUICK SEARCH Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->

        <details class="panel-disclosure" id="people-ops-block">
          <summary>People / Officer / PSC Search</summary>
          <div id="psc-progress" class="cp-progress done">
            <div class="cp-progress-label">
              <span id="psc-progress-text">Searching...</span>
              <span id="psc-progress-pct"></span>
            </div>
            <div class="cp-progress-track">
              <div class="cp-progress-fill" id="psc-progress-fill"></div>
            </div>
          </div>

          <label for="psc_name">Person / Officer Name</label>
          <input id="psc_name" type="text" placeholder="e.g. John Smith" title="Search for officers by name (min 3 characters)" />

          <label for="psc_company">Company Number (for PSC)</label>
          <input id="psc_company" type="text" placeholder="e.g. 08209948" title="View PSC data for a specific company" />

          <div class="cp-btn-row">
            <button id="psc_search" class="btn-primary" title="Search for PSC or officers via API">Search API</button>
            <button id="psc_clear" class="btn-secondary">Clear</button>
          </div>

          <div class="psc-help-text">
            Enter a person's name to search officer appointments, or a company number to view PSC records with PDF download.
          </div>

          <div id="psc-results-skeleton" class="cp-skeleton-list hidden" aria-hidden="true">
            <div class="cp-skeleton-row"></div>
            <div class="cp-skeleton-row"></div>
            <div class="cp-skeleton-row"></div>
          </div>
          <div id="psc_results"></div>
        </details>

        <details class="panel-disclosure" id="land-registry-block">
          <summary>Land Registry (Price Paid)</summary>
          <label for="lr-postcode">Postcode</label>
          <div class="roads-row">
            <input id="lr-postcode" type="text" placeholder="e.g. SW1A 1AA" />
            <button id="lr-search-btn" class="btn-primary btn-sm" type="button">Search</button>
          </div>
          <div class="psc-help-text">
            Queries HM Land Registry Price Paid Data. Shows recent property transactions at a postcode.
          </div>
          <div id="lr-results" class="nr-results"></div>
        </details>

        <details class="panel-disclosure" id="disqualified-directors-block">
          <summary>Disqualified Directors</summary>
          <label for="dq-name">Director Name</label>
          <div class="roads-row">
            <input id="dq-name" type="text" placeholder="e.g. John Smith" />
            <button id="dq-search-btn" class="btn-primary btn-sm" type="button">Search</button>
          </div>
          <div class="psc-help-text">
            Searches Companies House disqualified officers register.
          </div>
          <div id="dq-results" class="nr-results"></div>
        </details>

        <details class="panel-disclosure" id="charity-block">
          <summary>Charity Commission</summary>
          <label for="charity-name">Charity Name</label>
          <div class="roads-row">
            <input id="charity-name" type="text" placeholder="e.g. British Red Cross" />
            <button id="charity-search-btn" class="btn-primary btn-sm" type="button">Search</button>
          </div>
          <div class="psc-help-text">
            Searches the Charity Commission register for England & Wales.
          </div>
          <div id="charity-results" class="nr-results"></div>
        </details>

        <details class="panel-disclosure" id="dvla-ops-block">
          <summary>DVLA Vehicle Lookup</summary>
          <label for="dvla-vrm-input">Registration Number (VRM)</label>
          <div class="roads-row">
            <input id="dvla-vrm-input" type="text" placeholder="e.g. AB12CDE" />
            <button id="dvla-lookup-btn" class="btn-primary btn-sm" type="button">Lookup</button>
          </div>
          <div class="cp-btn-row">
            <button id="dvla-clear-btn" class="btn-secondary btn-sm" type="button">Clear</button>
          </div>
          <div class="psc-help-text">
            Queries DVLA Vehicle Enquiry Service via proxy. Results can be added to map as i2 Vehicle entities.
          </div>
          <div id="dvla-results" class="nr-results"></div>
        </details>

      </div>

      <!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â Entities Tab Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
      <div class="cp-tab-pane" id="tab-entities" role="tabpanel" aria-labelledby="cp-tab-btn-entities" aria-hidden="true">
        <div class="cp-quick-actions" aria-label="Entity quick actions">
          <button id="quick-entity-place" class="quick-action-btn" type="button">Place Entity</button>
          <button id="quick-entity-import" class="quick-action-btn" type="button">Import File</button>
          <button id="quick-entity-export" class="quick-action-btn" type="button">Export Excel</button>
        </div>
        <div class="cp-quick-hint">Use drag-and-drop import for fast demos, then refine with manual links.</div>

        <div class="entity-help">
          <strong>Entity Placement + i2 Workspace</strong>
          <p><strong>To place:</strong> Click a category below -> click on map -> enter details (name, address, notes)</p>
          <p><strong>To connect:</strong> Click Connect on any entity -> click target entity -> enter label</p>
          <p>Icons auto-suggest based on i2 fields and entity content.</p>
        </div>

        <div class="entity-import-panel">
          <div class="entity-import-title">Import Files</div>
          <input id="entity-import-file" type="file" accept=".xlsx,.xls,.csv,.tsv,.txt,.json,.geojson" />
          <div class="cp-btn-row">
            <button id="entity-import-run" class="btn-primary">Import And Plot</button>
            <button id="entity-import-template" class="btn-secondary" type="button">Download Template</button>
            <button id="entity-import-clear" class="btn-secondary">Clear Imported</button>
          </div>
          <div class="cp-btn-row">
            <button id="entity-select-box" class="btn-secondary" type="button">Box Select</button>
            <button id="entity-select-all" class="btn-secondary" type="button">Select All (Ctrl+A)</button>
            <button id="entity-export-excel" class="btn-secondary" type="button">Export Excel</button>
          </div>
          <div id="entity-import-summary" class="entity-import-summary">
            Supports `xlsx/xls/csv/tsv/txt` for entity import and `json/geojson` for overlay import. You can also drag and drop files here.
          </div>
        </div>
        
        <div id="entity_selector" class="entity-grid">
          <!-- Populated by JavaScript -->
        </div>
        
        <div class="entity-stats">
          <div class="entity-stat-item">
            <span class="entity-stat-label">Entities on map:</span>
            <span id="entity_count" class="entity-stat-value">0</span>
          </div>
          <div class="entity-stat-item">
            <span class="entity-stat-label">Connections:</span>
            <span id="connection_count" class="entity-stat-value">0</span>
          </div>
        </div>

        <details class="panel-disclosure">
          <summary>Search History &amp; Bookmarks</summary>
          <div id="search-history-list" class="search-history-list">
            <div class="activity-empty">No search history yet.</div>
          </div>
        </details>

        <details class="panel-disclosure">
          <summary>Workspace Manager</summary>
          <div class="ws-controls">
            <div class="roads-row">
              <input id="ws-name-input" type="text" placeholder="Workspace name" value="default" />
              <button id="ws-save-btn" class="btn-primary btn-sm" type="button">Save</button>
            </div>
            <div class="cp-btn-row">
              <button id="ws-quicksave-btn" class="btn-secondary btn-sm" type="button">Quick Save</button>
              <button id="ws-quickload-btn" class="btn-secondary btn-sm" type="button">Quick Load</button>
            </div>
            <div class="psc-help-text">
              Save/restore your entire workspace: entities, connections, map position, layers. Auto-saves every 2 minutes.
            </div>
          </div>
          <div id="workspace-list" class="workspace-list">
            <div class="activity-empty">No saved workspaces.</div>
          </div>
        </details>

        <details class="panel-disclosure">
          <summary>Data Sources Available</summary>
          <div class="data-sources-grid">
            <div class="ds-item ds-open"><span class="ds-dot ds-dot-green"></span><span class="ds-name">Companies House</span><span class="ds-badge">API</span></div>
            <div class="ds-item ds-open"><span class="ds-dot ds-dot-green"></span><span class="ds-name">PSC Register</span><span class="ds-badge">API</span></div>
            <div class="ds-item ds-open"><span class="ds-dot ds-dot-green"></span><span class="ds-name">Land Registry</span><span class="ds-badge">API</span></div>
            <div class="ds-item ds-open"><span class="ds-dot ds-dot-green"></span><span class="ds-name">Charity Commission</span><span class="ds-badge">API</span></div>
            <div class="ds-item ds-open"><span class="ds-dot ds-dot-green"></span><span class="ds-name">DVLA VES</span><span class="ds-badge">PROXY</span></div>
            <div class="ds-item ds-open"><span class="ds-dot ds-dot-green"></span><span class="ds-name">TfL Unified</span><span class="ds-badge">API</span></div>
            <div class="ds-item ds-open"><span class="ds-dot ds-dot-green"></span><span class="ds-name">FlightRadar24</span><span class="ds-badge">LIVE</span></div>
            <div class="ds-item ds-open"><span class="ds-dot ds-dot-green"></span><span class="ds-name">National Rail</span><span class="ds-badge">STATIC</span></div>
            <div class="ds-item ds-restricted"><span class="ds-dot ds-dot-amber"></span><span class="ds-name">PNC</span><span class="ds-badge ds-badge-restricted">RESTRICTED</span></div>
            <div class="ds-item ds-restricted"><span class="ds-dot ds-dot-amber"></span><span class="ds-name">PND</span><span class="ds-badge ds-badge-restricted">RESTRICTED</span></div>
            <div class="ds-item ds-restricted"><span class="ds-dot ds-dot-amber"></span><span class="ds-name">SARs / ELMER</span><span class="ds-badge ds-badge-restricted">RESTRICTED</span></div>
            <div class="ds-item ds-restricted"><span class="ds-dot ds-dot-amber"></span><span class="ds-name">Experian</span><span class="ds-badge ds-badge-restricted">RESTRICTED</span></div>
            <div class="ds-item ds-restricted"><span class="ds-dot ds-dot-amber"></span><span class="ds-name">GB Connexus</span><span class="ds-badge ds-badge-restricted">RESTRICTED</span></div>
          </div>
          <div class="psc-help-text">
            Open sources connect via API. Restricted sources are available for manual entry in 3x5x2 intelligence reports only.
          </div>
        </details>

        <details class="panel-disclosure" id="entities-i2-workspace">
          <summary>i2 Planning Workspace</summary>
          <div class="i2-stats-grid">
            <div class="i2-stat-card">
              <span class="i2-stat-label">Import Templates</span>
              <span id="i2-template-count" class="i2-stat-value">--</span>
            </div>
            <div class="i2-stat-card">
              <span class="i2-stat-label">Entity Types</span>
              <span id="i2-entity-count" class="i2-stat-value">--</span>
            </div>
            <div class="i2-stat-card">
              <span class="i2-stat-label">Link Types</span>
              <span id="i2-link-count" class="i2-stat-value">--</span>
            </div>
            <div class="i2-stat-card">
              <span class="i2-stat-label">Match Rules</span>
              <span id="i2-rule-count" class="i2-stat-value">--</span>
            </div>
          </div>

          <label for="i2-template-select">Import Template</label>
          <select id="i2-template-select">
            <option value="">Loading templates...</option>
          </select>
          <div id="i2-template-details" class="i2-panel-block">Select a template to inspect mappings.</div>

          <label for="i2-entity-search">Entity Type Search</label>
          <input id="i2-entity-search" type="text" placeholder="e.g. Communication Entity, Aircraft, Person" />
          <div id="i2-entity-results" class="i2-panel-block">Loading catalog...</div>
        </details>
      </div>

      <!-- Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â Layers Tab Ã¢â€¢ÂÃ¢â€¢ÂÃ¢â€¢Â -->
      <div class="cp-tab-pane" id="tab-layers" role="tabpanel" aria-labelledby="cp-tab-btn-layers" aria-hidden="true">
        <div class="cp-quick-actions" aria-label="Layer quick actions">
          <button id="quick-layer-underground" class="quick-action-btn" type="button">Toggle TfL</button>
          <button id="quick-layer-flights" class="quick-action-btn" type="button">Toggle Flights</button>
          <button id="quick-layer-health" class="quick-action-btn" type="button">Refresh Health</button>
        </div>
        <div class="cp-quick-hint">Layers load on demand. Turn on only what you need for smoother map performance.</div>

        <div class="layer-section-title">Layer Presets</div>
        <div class="cp-btn-row">
          <button id="layer-preset-transport" class="btn-secondary" type="button">Transport Focus</button>
          <button id="layer-preset-intel" class="btn-secondary" type="button">Intel Focus</button>
          <button id="layer-preset-clear" class="btn-secondary" type="button">Clear All</button>
        </div>
        <div class="cp-quick-hint">Presets toggle multiple layers in one click. You can still fine-tune manually.</div>

        <div class="layer-section-title">Base Map</div>
        <div class="base-pills" id="base-pills">
          <button class="bl-pill active" data-base="Dark">Dark</button>
          <button class="bl-pill" data-base="Grey">Grey</button>
          <button class="bl-pill" data-base="Street">Street</button>
          <button class="bl-pill" data-base="Satellite">Satellite</button>
        </div>

        <div class="layer-section-title">Overlay Groups</div>

        <details class="panel-disclosure" open>
          <summary>Transport</summary>

          <label class="layer-row">
            <input type="checkbox" class="layer-cb" data-layer="underground">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-dot" style="background:#f43f5e"></span>
            <span class="layer-name">TfL Stations (Underground, DLR, Tram, Rail)</span>
          </label>

          <label class="layer-row">
            <input type="checkbox" class="layer-cb" data-layer="national_rail">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-dot" style="background:#38bdf8"></span>
            <span class="layer-name">National Rail Stations (GB)</span>
          </label>

          <label class="layer-row">
            <input type="checkbox" class="layer-cb" data-layer="service_stations">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-dot" style="background:#facc15"></span>
            <span class="layer-name">Service Stations (Fuel/EV)</span>
          </label>

          <label class="layer-row">
            <input type="checkbox" class="layer-cb" data-layer="bikes">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-dot" style="background:#22c55e"></span>
            <span class="layer-name">Santander Cycles</span>
          </label>

          <label class="layer-row">
            <input type="checkbox" class="layer-cb" data-layer="seaports">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-dot" style="background:#2dd4bf"></span>
            <span class="layer-name">Seaports</span>
          </label>
        </details>

        <details class="panel-disclosure">
          <summary>Aviation</summary>

          <label class="layer-row">
            <input type="checkbox" class="layer-cb" data-layer="airports_uk">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-dot" style="background:#38bdf8"></span>
            <span class="layer-name">UK Airports</span>
          </label>

          <label class="layer-row">
            <input type="checkbox" class="layer-cb" data-layer="airports_global">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-dot" style="background:#0284c7"></span>
            <span class="layer-name">Global Airports</span>
          </label>

          <label class="layer-row">
            <input type="checkbox" class="layer-cb" data-layer="flights">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-dot" style="background:#f59e0b"></span>
            <span class="layer-name">Live Flights (FlightRadar24)</span>
          </label>
        </details>

        <details class="panel-disclosure">
          <summary>Intel & Core</summary>

          <label class="layer-row">
            <input type="checkbox" class="layer-cb" data-layer="areas">
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-dot" style="background:#818cf8"></span>
            <span class="layer-name">Police Force Areas</span>
          </label>

          <label class="layer-row">
            <input type="checkbox" class="layer-cb" data-layer="companies" checked>
            <span class="toggle-track"><span class="toggle-thumb"></span></span>
            <span class="layer-dot" style="background:#a78bfa"></span>
            <span class="layer-name">Companies (search)</span>
          </label>
        </details>

        <details class="panel-disclosure layer-tool-block">
          <summary>Airport Finder</summary>
          <div class="airport-tools">
            <label for="airport-search-q">Airport (IATA / ICAO / Name / City)</label>
            <div class="airport-row">
              <input id="airport-search-q" type="text" placeholder="e.g. BRS, EGGD, Bristol" />
              <button id="airport-search-btn" class="btn-secondary btn-sm" type="button">Find</button>
            </div>
            <div class="airport-row">
              <button id="airport-search-clear-btn" class="btn-secondary btn-sm" type="button">Clear</button>
            </div>
            <div id="airport-search-results" class="airport-results"></div>
          </div>
        </details>

        <details class="panel-disclosure layer-tool-block" data-layer-tools="flights">
          <summary>Flight Intelligence Filters</summary>
          <div class="flight-intel-tools">
            <label for="flight-airport-q">Airport (IATA/ICAO/Name/City)</label>
            <input id="flight-airport-q" type="text" placeholder="e.g. LHR, EGLL, Heathrow, London" />

            <label for="flight-origin-q">Origin Airport</label>
            <input id="flight-origin-q" type="text" placeholder="IATA/ICAO/Name/City" />

            <label for="flight-destination-q">Destination Airport</label>
            <input id="flight-destination-q" type="text" placeholder="IATA/ICAO/Name/City" />

            <label for="flight-aircraft-q">Aircraft (ICAO24)</label>
            <input id="flight-aircraft-q" type="text" placeholder="e.g. 40621a" />

            <label for="flight-number-q">Flight Number / Callsign</label>
            <input id="flight-number-q" type="text" placeholder="e.g. BAW130" />

            <label class="inline-checkbox">
              <input id="flight-passenger-large-only" type="checkbox" checked />
              Show only passenger / largest aircraft
            </label>

            <div class="flight-intel-time-row">
              <div>
                <label for="flight-time-from">Seen From</label>
                <input id="flight-time-from" type="time" />
              </div>
              <div>
                <label for="flight-time-to">Seen To</label>
                <input id="flight-time-to" type="time" />
              </div>
            </div>

            <div class="flight-intel-actions">
              <button id="flight-filter-btn" class="btn-secondary btn-sm" type="button">Apply Flight Filter</button>
              <button id="flight-filter-clear-btn" class="btn-secondary btn-sm" type="button">Clear Filter</button>
            </div>
            <div id="flight-filter-results" class="flight-filter-results"></div>
          </div>
        </details>

        <details class="panel-disclosure layer-tool-block" data-layer-tools="service_stations">
          <summary>Service Station Filters</summary>
          <div class="service-filter-tools">
            <label class="inline-checkbox">
              <input id="ss-filter-fuel" type="checkbox" checked />
              Fuel
            </label>
            <label class="inline-checkbox">
              <input id="ss-filter-charging" type="checkbox" checked />
              EV Charging
            </label>
            <label class="inline-checkbox">
              <input id="ss-filter-vehicle" type="checkbox" checked />
              Repair / Wash
            </label>
            <label class="inline-checkbox">
              <input id="ss-filter-truck" type="checkbox" checked />
              Truck Stops
            </label>
            <label class="inline-checkbox">
              <input id="ss-filter-general" type="checkbox" checked />
              Other
            </label>
            <div class="cp-btn-row">
              <button id="ss-filter-all-btn" class="btn-secondary btn-sm" type="button">All</button>
              <button id="ss-filter-none-btn" class="btn-secondary btn-sm" type="button">None</button>
            </div>
          </div>
        </details>

        <details class="panel-disclosure layer-tool-block" data-layer-tools="underground">
          <summary>
            TfL Line Status
            <span id="tfl-status-time" class="tfl-status-time">--:--</span>
          </summary>
          <div id="tfl-selected-line" class="tfl-selected-line">Selected: None</div>
          <div id="tfl-status-grid"></div>
        </details>

        <details class="panel-disclosure layer-tool-block" data-layer-tools="underground">
          <summary>TfL StopPoint Ops</summary>
          <div class="tfl-stop-tools">
            <label for="tfl-stop-query">Search Stops / Stations</label>
            <div class="tfl-stop-row">
              <input id="tfl-stop-query" type="text" placeholder="e.g. Baker Street or 490008660N" />
              <button id="tfl-stop-search-btn" class="btn-secondary btn-sm" type="button">Search</button>
            </div>

            <label for="tfl-stop-mode">Mode Filter</label>
            <select id="tfl-stop-mode">
              <option value="">All modes</option>
              <option value="tube">Tube</option>
              <option value="overground">Overground</option>
              <option value="elizabeth-line">Elizabeth line</option>
              <option value="dlr">DLR</option>
              <option value="tram">Tram</option>
              <option value="bus">Bus</option>
            </select>

            <div class="tfl-stop-row">
              <button id="tfl-stop-nearby-btn" class="btn-secondary btn-sm" type="button">Nearby (Map Center)</button>
              <button id="tfl-stop-clear-btn" class="btn-secondary btn-sm" type="button">Clear</button>
            </div>
          <div id="tfl-stop-results" class="tfl-stop-results"></div>
          </div>
        </details>

        <details class="panel-disclosure layer-tool-block" data-layer-tools="national_rail">
          <summary>National Rail Ops</summary>
          <div class="nr-tools">
            <label for="nr-station-query">Station / CRS</label>
            <div class="nr-row">
              <input id="nr-station-query" type="text" placeholder="e.g. Kings Cross or KGX" />
              <button id="nr-station-search-btn" class="btn-secondary btn-sm" type="button">Search</button>
            </div>
            <div class="nr-row">
              <button id="nr-station-nearby-btn" class="btn-secondary btn-sm" type="button">Nearby (Map Center)</button>
              <button id="nr-station-clear-btn" class="btn-secondary btn-sm" type="button">Clear</button>
            </div>
            <div id="nr-selected-line" class="nr-selected-line">Selected Major Line: None</div>
            <div class="cp-btn-row">
              <button id="nr-mode-major-btn" class="btn-secondary btn-sm" type="button">Major Only</button>
              <button id="nr-mode-minor-btn" class="btn-secondary btn-sm" type="button">Minor Only</button>
              <button id="nr-mode-all-net-btn" class="btn-secondary btn-sm" type="button">All</button>
            </div>
            <div class="cp-btn-row">
              <button id="nr-line-all-btn" class="btn-secondary btn-sm" type="button">All Lines</button>
              <button id="nr-line-none-btn" class="btn-secondary btn-sm" type="button">No Lines</button>
            </div>
            <div id="nr-major-line-grid" class="nr-major-line-grid"></div>
            <div id="nr-station-results" class="nr-results"></div>
          </div>
        </details>

      </div>

    </div>
  </div>

  <!-- Status bar -->
  <div id="status-bar">
    <div class="status-left">
      <span class="status-indicator" id="status-indicator"></span>
      <span id="status-text" role="status" aria-live="polite">Initialising...</span>
    </div>
    <div class="status-center">
      <span class="status-session-chip" id="status-session">Session: 0m</span>
    </div>
    <div id="status-health-mini" class="status-health-mini">
      <span class="status-health-chip">Health: checking...</span>
    </div>
  </div>

  <!-- Entity Placement Panel -->
  <div id="entity-placement-panel" class="entity-panel">
    <div class="entity-panel-header">
      <span class="entity-panel-title">PLACE ENTITY</span>
      <div class="entity-panel-header-actions">
        <button id="entity-panel-minimize" class="entity-panel-min-btn" type="button" title="Minimize panel">-</button>
        <button id="entity-panel-close" class="entity-panel-close-btn" type="button" title="Close panel">&times;</button>
      </div>
    </div>
    <div class="entity-panel-body">
      <form id="entity-placement-form">
        <label for="entity-label">Display Label <span style="opacity: 0.5; font-weight: 400;">(optional override)</span></label>
        <input type="text" id="entity-label" placeholder="Leave blank to derive from i2 fields" />
        
        <label for="entity-category">Category</label>
        <select id="entity-category" required>
          <option value="">Select category...</option>
        </select>
        
        <label for="entity-icon">Icon</label>
        <select id="entity-icon" required>
          <option value="">Select icon...</option>
        </select>
        <div id="entity-icon-picker" class="entity-icon-picker"></div>
        <div id="entity-icon-preview" class="entity-icon-preview">
          <img id="entity-icon-preview-img" src="" alt="Selected icon preview" />
          <span id="entity-icon-preview-label">No icon selected</span>
        </div>

        <label for="entity-i2-type">i2 Entity Type</label>
        <select id="entity-i2-type">
          <option value="">Loading i2 entity types...</option>
        </select>

        <div class="cp-btn-row entity-panel-actions-top">
          <button type="submit" class="btn-primary">PLACE ENTITY</button>
          <button type="button" class="btn-secondary" id="entity-cancel-btn">CANCEL</button>
        </div>

        <div id="entity-i2-fields" class="entity-i2-fields">
          <div class="entity-i2-fields-empty">Loading i2 properties...</div>
        </div>

        <label for="entity-placement-address">Placement Address / Postcode <span style="opacity: 0.5; font-weight: 400;">(optional)</span></label>
        <input type="text" id="entity-placement-address" placeholder="e.g. 1 Osmond Drive, Wells, BA5 2JX" />
        <div class="entity-i2-meta">Used for map geocoding when postcode/address is not present in i2 fields.</div>
        
        <div class="entity-panel-coords">
          <span class="popup-label">Coordinates</span>
          <span id="entity-coords">--</span>
        </div>
        
      </form>
    </div>
  </div>

  <div id="map"></div>

  <!-- ═══ BOTTOM ANALYSIS PANEL ═══ -->
  <div id="bottom-panel" class="bottom-panel">
    <div class="bp-header">
      <div class="bp-tabs">
        <button class="bp-tab-btn" data-bp-target="graph" title="Network Graph (Ctrl+G)">Link Analysis</button>
        <button class="bp-tab-btn" data-bp-target="timeline" title="Timeline (Ctrl+T)">Timeline</button>
        <button class="bp-tab-btn" data-bp-target="activity" title="Activity Log (Ctrl+H)">Activity</button>
      </div>
      <div class="bp-header-right">
        <div id="graph-stats" class="bp-stats"></div>
        <div id="timeline-stats" class="bp-stats" style="display:none"></div>
        <button class="bp-close-btn" id="bp-close-btn" title="Close panel">&times;</button>
      </div>
    </div>
    <div class="bp-body">
      <!-- Graph Tab -->
      <div class="bp-tab-pane" data-bp-tab="graph">
        <div id="graph-toolbar" class="graph-toolbar"></div>
        <div id="network-graph-container" class="network-graph-container"></div>
      </div>
      <!-- Timeline Tab -->
      <div class="bp-tab-pane" data-bp-tab="timeline">
        <div id="timeline-toolbar" class="graph-toolbar"></div>
        <div id="timeline-container" class="timeline-container"></div>
      </div>
      <!-- Activity Tab -->
      <div class="bp-tab-pane" data-bp-tab="activity">
        <div id="activity-log-list" class="activity-log-list"></div>
      </div>
    </div>
  </div>

  <button id="mobile-panel-toggle" class="mobile-panel-toggle" type="button" title="Toggle control panel">Panel</button>
  <div id="toast-stack" class="toast-stack" aria-live="polite" aria-atomic="false"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- API Keys (gitignored Ã¢â‚¬â€ copy api_keys.example.js to api_keys.js) -->
  <script src="js/api_keys.js"></script>

  <!-- Core Config -->
  <script src="js/config.js"></script>
  <script src="js/api_base.js"></script>

  <!-- API Modules -->
  <script src="js/ch_api.js"></script>
  <script src="js/psc_api.js"></script>

  <!-- Icons -->
  <script src="js/icons.js"></script>

  <!-- Map -->
  <script src="js/map.js"></script>

  <!-- Live Data Layers -->
  <script src="js/tfl_live.js"></script>
  <script src="js/national_rail_live.js"></script>
  <script src="js/flights.js"></script>
  <script src="js/dvla.js"></script>
  <script src="js/system_health.js"></script>
  <script src="js/i2_workspace.js"></script>

  <!-- Intelligence Dashboard Modules -->
  <script src="js/dashboard.js"></script>
  <script src="js/network_graph.js"></script>
  <script src="js/timeline.js"></script>
  <script src="js/context_menu.js"></script>
  <script src="js/intel_export.js"></script>

  <!-- Wire KPI bar action buttons -->
  <script>
    document.getElementById("kpi-btn-save")?.addEventListener("click", () => {
      if (window.CRDashboard) window.CRDashboard.saveWorkspace("quicksave");
    });
    document.getElementById("kpi-btn-report")?.addEventListener("click", () => {
      if (typeof window.generate3x5x2Report === "function") window.generate3x5x2Report();
    });
    document.getElementById("kpi-btn-anx")?.addEventListener("click", () => {
      if (typeof window.exportI2ANX === "function") window.exportI2ANX();
    });
    document.getElementById("kpi-btn-excel")?.addEventListener("click", () => {
      if (typeof window.exportStructuredExcel === "function") window.exportStructuredExcel();
    });
    document.getElementById("kpi-btn-help")?.addEventListener("click", () => {
      if (window.CRDashboard) window.CRDashboard.showShortcutsOverlay();
    });
    // Wire Land Registry search
    document.getElementById("lr-search-btn")?.addEventListener("click", async () => {
      const pc = document.getElementById("lr-postcode")?.value?.trim();
      if (!pc) return;
      const results = await window.searchLandRegistry(pc);
      const container = document.getElementById("lr-results");
      if (!container) return;
      if (!results.length) { container.innerHTML = '<div class="nr-empty">No transactions found.</div>'; return; }
      container.innerHTML = results.map(r => `<div class="ch-result-item">
        <div class="ch-r-name">${r.address || "Unknown"}</div>
        <div class="ch-r-detail">&pound;${Number(r.price).toLocaleString()} &middot; ${r.date || ""} &middot; ${r.type || ""}</div>
      </div>`).join("");
    });
    // Wire Disqualified Directors search
    document.getElementById("dq-search-btn")?.addEventListener("click", async () => {
      const name = document.getElementById("dq-name")?.value?.trim();
      if (!name) return;
      const results = await window.searchDisqualifiedDirectors(name);
      const container = document.getElementById("dq-results");
      if (!container) return;
      if (!results.length) { container.innerHTML = '<div class="nr-empty">No disqualified directors found.</div>'; return; }
      container.innerHTML = results.map(r => `<div class="ch-result-item">
        <div class="ch-r-name" style="color:#ef4444">${r.name || "Unknown"}</div>
        <div class="ch-r-detail">DOB: ${r.dateOfBirth || "N/A"} &middot; ${r.address || ""}</div>
        <div class="ch-r-detail">Disqualified: ${r.disqualifiedFrom || "?"} to ${r.disqualifiedUntil || "?"}</div>
        ${r.snippet ? `<div class="ch-r-detail" style="color:#fbbf24">${r.snippet}</div>` : ""}
      </div>`).join("");
    });

    // Wire Charity Commission search
    document.getElementById("charity-search-btn")?.addEventListener("click", async () => {
      const name = document.getElementById("charity-name")?.value?.trim();
      if (!name) return;
      const results = await window.searchCharities(name);
      const container = document.getElementById("charity-results");
      if (!container) return;
      if (!results.length) { container.innerHTML = '<div class="nr-empty">No charities found.</div>'; return; }
      container.innerHTML = results.map(r => `<div class="ch-result-item">
        <div class="ch-r-name" style="color:#22c55e">${r.name || "Unknown"}</div>
        <div class="ch-r-detail">Reg: ${r.number || "N/A"} &middot; Status: ${r.status || "Unknown"}</div>
        ${r.activities ? `<div class="ch-r-detail">${r.activities.slice(0,120)}</div>` : ""}
      </div>`).join("");
    });

    // ── Live Clock, Coords & Zoom in KPI bar ──
    (function initKpiLiveInfo() {
      function updateClock() {
        const now = new Date();
        const el = document.getElementById("kpi-clock");
        if (el) el.textContent = now.toLocaleTimeString("en-GB", { hour12: false });
      }
      updateClock();
      setInterval(updateClock, 1000);

      // Update coords + zoom on map move
      function updateMapInfo() {
        if (!window._map) return;
        const c = window._map.getCenter();
        const z = window._map.getZoom();
        const coordsEl = document.getElementById("kpi-coords");
        const zoomEl = document.getElementById("kpi-zoom");
        if (coordsEl) coordsEl.textContent = c.lat.toFixed(4) + ", " + c.lng.toFixed(4);
        if (zoomEl) zoomEl.textContent = "Z" + z;
      }
      // Poll until map is ready, then bind
      const mapCheck = setInterval(() => {
        if (window._map) {
          clearInterval(mapCheck);
          window._map.on("moveend zoomend", updateMapInfo);
          updateMapInfo();
        }
      }, 500);

      // Update session time in status bar
      const sessionStart = Date.now();
      setInterval(() => {
        const elapsed = Date.now() - sessionStart;
        const mins = Math.floor(elapsed / 60000);
        const hrs = Math.floor(mins / 60);
        const dispMins = mins % 60;
        const el = document.getElementById("status-session");
        if (el) el.textContent = "Session: " + (hrs > 0 ? hrs + "h " + dispMins + "m" : dispMins + "m");
      }, 10000);
    })();
  </script>

</body>
</html>

